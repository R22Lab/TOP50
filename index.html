<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>РГСУ | Образовательный портал</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'], body: ['Inter', 'sans-serif'] },
                    colors: {
                        rgsu: { 900: '#002C5F', 800: '#004080', 700: '#0054A6', 600: '#1A6BC2', 50: '#EAF4FF' },
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', surface: '#1e293b' },
                        accent: { DEFAULT: '#F2994A', hover: '#E68A3E' }
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.4s ease-out forwards',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'toast': 'toastIn 0.3s ease-out forwards',
                        'pulse-soft': 'pulseSoft 2s infinite',
                        'fly': 'flyToCart 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'shimmer': 'shimmer 2s linear infinite'
                    },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        toastIn: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        pulseSoft: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.7' } },
                        flyToCart: {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '100%': { transform: 'translate(var(--tx), var(--ty)) scale(0.1)', opacity: '0' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' }
                        }
                    },
                    padding: {
                        'safe': 'env(safe-area-inset-bottom)'
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; }
        .dark body { background-color: #0f172a; }
        
        /* Noise Texture */
        .noise-bg { position: relative; }
        .noise-bg::before {
            content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            pointer-events: none; z-index: -1; opacity: 0.4;
        }

        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.95); border-color: rgba(255,255,255,0.1); }

        .card-hover { transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s ease, border-color 0.2s ease; border: 1px solid transparent; will-change: transform; }
        .card-hover:hover { 
            transform: translateY(-4px); 
            box-shadow: 0 20px 25px -5px rgba(0, 44, 95, 0.1);
            border-color: #3b82f6; 
            z-index: 10;
        }
        .dark .card-hover:hover { 
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.5); 
            border-color: #60a5fa; 
        }

        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 0.5rem; }
        .dark .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .custom-checkbox:checked { background-color: #0054A6; border-color: #0054A6; background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e"); }
        
        /* Optimized Sticky Header for Desktop */
        .sticky-filters { position: sticky; top: 64px; z-index: 40; }
        
        .diff-row { background-color: #FEF3C7; }
        .dark .diff-row { background-color: #383018; }
        
        #searchOverlay { transition: opacity 0.3s ease, visibility 0.3s ease; }
        #searchOverlay.active { opacity: 1; visibility: visible; }
        
        .custom-scrollbar::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }

        .badge-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        .shimmer-bg {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 3s infinite;
        }

        .layout-list { grid-template-columns: 1fr !important; }
        .layout-list .card-hover { flex-direction: row; align-items: center; padding: 1.5rem; }
        .layout-list .card-img { display: none; }
        @media (max-width: 768px) { 
            .layout-list .card-hover { flex-direction: column; align-items: flex-start; padding: 1.25rem; } 
            .layout-list .card-img { display: flex; }
            
            /* Mobile Modal Tweaks */
            #modalPanel { border-bottom-left-radius: 0; border-bottom-right-radius: 0; }
        }

        /* Print Styles */
        @media print {
            body { background: white; color: black; }
            #navbar, #heroSection, #filterPanel, #compareBar, #scrollTopBtn, .md\:hidden, #toastContainer, #scrollProgressContainer { display: none !important; }
            #modal { position: static; background: white; overflow: visible; height: auto; }
            #modalPanel { box-shadow: none; border: none; transform: none !important; max-width: 100%; }
            #modalContent { overflow: visible; max-height: none; padding: 0; }
            .no-print { display: none !important; }
        }
        
        /* Bottom Nav Safe Area */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 dark:text-slate-100 font-body transition-colors duration-300 pb-24 md:pb-0">

    <!-- Scroll Progress Bar -->
    <div id="scrollProgressContainer" class="fixed top-0 left-0 w-full h-1 z-[60] bg-transparent pointer-events-none">
        <div id="scrollProgressBar" class="h-full bg-gradient-to-r from-rgsu-600 to-accent width-0 transition-all duration-100"></div>
    </div>

    <!-- Search Focus Overlay -->
    <div id="searchOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-40 opacity-0 invisible" onclick="blurSearch()"></div>

    <!-- Navbar (Desktop) -->
    <header class="fixed w-full top-0 z-50 glass-panel border-b border-slate-200/80 shadow-sm transition-all duration-300 dark:border-slate-800 noise-bg" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between relative z-10">
            <a href="https://www.rgsu.net" class="flex items-center gap-3 group">
                <img src="https://upload.wikimedia.org/wikipedia/ru/archive/4/42/20240520114700%21%D0%A0%D0%93%D0%A1%D0%A3_%D0%BB%D0%BE%D0%B3%D0%BE%D1%82%D0%B8%D0%BF.png" alt="Логотип" class="h-9 w-auto group-hover:scale-105 transition-transform duration-300 bg-white dark:bg-transparent rounded-lg p-0.5">
                <div class="hidden md:block border-l-2 border-rgsu-200 dark:border-slate-700 pl-4">
                    <h1 class="font-bold text-rgsu-900 dark:text-white text-xs uppercase tracking-wide">РГСУ</h1>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 font-medium uppercase">Образование</p>
                </div>
            </a>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="hidden md:block p-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 transition active:scale-95" title="Сменить тему">
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                </button>
                <div class="relative hidden md:block">
                    <button onclick="toggleFavFilter()" id="favFilterBtn" class="flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-200 text-slate-600 hover:border-red-300 hover:text-red-500 hover:bg-red-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 transition-all text-sm font-medium relative group active:scale-95">
                        <i data-lucide="heart" class="w-4 h-4 transition-transform group-active:scale-125" id="navHeartIcon"></i> <span class="hidden sm:inline">Избранное</span>
                        <span id="favCountBadge" class="absolute -top-1.5 -right-1.5 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-sm hidden badge-pop">0</span>
                    </button>
                    <button onclick="exportFavoritesCSV()" id="exportFavBtn" class="absolute top-12 right-0 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-xl rounded-xl p-3 w-48 text-left text-sm hidden animate-fade-in z-50 flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700" title="Скачать Excel">
                        <i data-lucide="download" class="w-4 h-4 text-slate-400"></i> Скачать CSV
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <div class="bg-rgsu-900 dark:bg-slate-900 pt-24 md:pt-32 pb-10 md:pb-16 px-4 relative overflow-hidden text-center transition-colors duration-500" id="heroSection">
        <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-rgsu-600/20 rounded-full blur-3xl translate-x-1/3 -translate-y-1/4 animate-pulse-soft transition-transform duration-100 ease-out" id="heroBlob1"></div>
        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-accent/10 rounded-full blur-3xl -translate-x-1/3 translate-y-1/4 transition-transform duration-100 ease-out" id="heroBlob2"></div>
        
        <div class="relative z-10 max-w-4xl mx-auto animate-fade-in">
            <h2 class="text-3xl md:text-5xl font-extrabold text-white mb-4 leading-tight">Найди свою <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-white">профессию</span></h2>
            
            <div class="flex flex-wrap justify-center gap-3 md:gap-4 mb-6 text-white/80 text-xs sm:text-sm font-medium">
                <div class="flex items-center gap-1.5 px-3 py-1 bg-white/5 rounded-full backdrop-blur-sm border border-white/10">
                    <span class="text-accent font-bold text-lg" id="statsPrograms">0</span> <span class="text-[10px] uppercase tracking-wider">Программ</span>
                </div>
                <div class="flex items-center gap-1.5 px-3 py-1 bg-white/5 rounded-full backdrop-blur-sm border border-white/10">
                    <span class="text-blue-300 font-bold text-lg" id="statsUnis">0</span> <span class="text-[10px] uppercase tracking-wider">Уч. заведений</span>
                </div>
            </div>

            <div class="relative max-w-xl mx-auto z-50">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-2 flex gap-2 ring-4 ring-white/10 dark:ring-slate-700/50 transition-all duration-300" id="searchContainer">
                    <div class="flex-grow flex items-center px-3 bg-slate-50 dark:bg-slate-900/50 rounded-xl relative group focus-within:ring-2 focus-within:ring-rgsu-600 transition-all">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400 group-focus-within:text-rgsu-600 transition-colors"></i>
                        <input type="text" id="searchInput" placeholder="Профессия, учебное заведение или код..." class="w-full pl-3 py-3.5 outline-none bg-transparent text-sm pr-8 placeholder:text-slate-400 dark:text-white" onfocus="focusSearch()" oninput="handleSearchInput(this.value)">
                        <button onclick="clearSearch()" id="clearSearchBtn" class="hidden absolute right-2 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <!-- Smart Autocomplete Dropdown -->
                <div id="searchHistoryDropdown" class="absolute top-full left-2 right-2 bg-white dark:bg-slate-800 rounded-xl shadow-xl mt-2 overflow-hidden hidden z-50 border border-slate-100 dark:border-slate-700 text-left">
                    <!-- JS fills this -->
                </div>
            </div>
            
            <!-- Category Carousel -->
            <div id="popularFilters" class="flex flex-nowrap overflow-x-auto gap-3 mt-6 pb-2 px-4 justify-start md:justify-center no-scrollbar relative z-10 snap-x">
                <!-- JS injected -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 -mt-4 md:-mt-6 pb-24 md:pb-20 relative z-20 flex-grow w-full">
        
        <!-- Mobile Filter Trigger (Secondary, Main one in Bottom Nav) -->
        <div class="md:hidden flex justify-between items-center mb-4 px-1">
             <h3 class="font-bold text-lg text-slate-800 dark:text-white" id="mobileResultsCount">Программы</h3>
             <div class="flex gap-2">
                 <button onclick="toggleLayout()" class="p-2 bg-white dark:bg-slate-800 rounded-lg shadow-sm text-slate-500"><i data-lucide="layout-grid" class="w-5 h-5"></i></button>
             </div>
        </div>

        <!-- Desktop Filter Panel -->
        <div id="filterPanel" class="hidden md:flex sticky-filters flex-col gap-4 bg-white dark:bg-slate-800/90 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-700 p-4 mb-6 backdrop-blur-md transition-all noise-bg">
            <div class="flex flex-col xl:flex-row gap-4 justify-between items-start xl:items-center relative z-10">
                <div class="flex flex-col md:flex-row gap-4 w-full xl:w-auto">
                    <div id="levelButtons" class="flex p-1.5 bg-slate-100 dark:bg-slate-900 rounded-xl w-full md:w-auto overflow-x-auto gap-1"></div>
                    
                    <div class="relative w-full md:w-48">
                        <div class="relative group">
                            <input list="regions" id="regionInput" placeholder="Регион..." onchange="updateFilters()" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-rgsu-600 dark:focus:border-blue-500 focus:ring-2 focus:ring-rgsu-600/10 dark:text-white transition pr-9">
                            <i data-lucide="map-pin" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-rgsu-600 transition-colors pointer-events-none" id="regionIcon"></i>
                            <button onclick="clearRegion()" id="clearRegionBtn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-white p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition bg-transparent"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <datalist id="regions"></datalist>
                    </div>

                    <div class="relative w-full md:w-56">
                        <div class="relative group">
                            <input list="universities" id="universityInput" placeholder="Учебное заведение..." onchange="updateFilters()" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-rgsu-600 dark:focus:border-blue-500 focus:ring-2 focus:ring-rgsu-600/10 dark:text-white transition pr-9">
                            <i data-lucide="graduation-cap" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-rgsu-600 transition-colors pointer-events-none" id="uniIcon"></i>
                            <button onclick="clearUniversity()" id="clearUniBtn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-white p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition bg-transparent"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <datalist id="universities"></datalist>
                    </div>

                    <div class="relative w-full md:w-40">
                        <select id="sortSelect" onchange="updateFilters()" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-rgsu-600 dark:focus:border-blue-500 cursor-pointer appearance-none dark:text-white">
                            <option value="default">Сортировка</option>
                            <option value="budget_desc">Бюджет (убыв.)</option>
                            <option value="name_asc">Название (А-Я)</option>
                            <option value="region_asc">Регион (А-Я)</option>
                        </select>
                        <i data-lucide="arrow-up-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-4 w-full xl:w-auto border-t xl:border-none pt-4 xl:pt-0 dark:border-slate-700">
                    <label class="flex items-center gap-2 cursor-pointer select-none group">
                        <input type="checkbox" id="budgetToggle" class="custom-checkbox w-5 h-5 border-2 border-slate-300 dark:border-slate-600 rounded focus:ring-2 focus:ring-rgsu-600 focus:ring-offset-1 cursor-pointer appearance-none bg-white dark:bg-slate-700 transition-all" onchange="updateFilters()">
                        <span class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-rgsu-900 dark:group-hover:text-white transition-colors">Бюджет</span>
                    </label>
                    <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1 hidden sm:block"></div>
                    <button onclick="toggleLayout()" id="layoutToggleBtn" class="p-2 text-slate-400 hover:text-rgsu-700 hover:bg-slate-50 dark:hover:bg-slate-700 dark:hover:text-white rounded-lg transition active:scale-95" title="Вид: Список/Плитка">
                        <i data-lucide="layout-grid" class="w-5 h-5"></i>
                    </button>
                    <button onclick="resetAllFilters()" id="globalResetBtn" class="hidden p-2 text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition active:scale-95" title="Сбросить всё">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
            <div id="activeFilters" class="flex flex-wrap gap-2 text-xs empty:hidden pt-2 border-t border-slate-100 dark:border-slate-700 relative z-10"></div>
            <div id="resultsCount" class="hidden"></div>
        </div>

        <!-- Cards Grid -->
        <div id="catalogGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6 transition-all duration-300">
            <div class="skeleton h-64 rounded-2xl"></div><div class="skeleton h-64 rounded-2xl"></div><div class="skeleton h-64 rounded-2xl"></div>
        </div>

        <!-- Infinite Scroll Sentinel -->
        <div id="sentinel" class="mt-8 h-10 w-full flex items-center justify-center">
             <svg class="animate-spin h-6 w-6 text-slate-400 hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </div>
        
        <!-- Recently Viewed Section -->
        <div id="recentlyViewedSection" class="mt-12 mb-4 hidden">
            <h3 class="text-lg font-bold text-slate-800 dark:text-white mb-3 px-2">Вы недавно смотрели</h3>
            <div class="overflow-x-auto pb-4 -mx-4 px-4 custom-scrollbar">
                <div class="flex gap-3" id="recentlyViewedList"></div>
            </div>
        </div>
    </main>

    <!-- Scroll to Top Button -->
    <button id="scrollTopBtn" onclick="scrollToTop()" class="fixed bottom-24 right-6 z-40 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-3.5 rounded-full shadow-lg text-slate-500 dark:text-slate-400 hover:text-rgsu-700 dark:hover:text-white hover:shadow-xl transition-all hidden translate-y-10 opacity-0 duration-300 active:scale-90 md:bottom-12 z-[45]">
        <i data-lucide="arrow-up" class="w-6 h-6"></i>
    </button>

    <!-- Comparison Bar (Fixed Bottom) -->
    <div id="compareBar" class="fixed bottom-24 md:bottom-6 left-1/2 transform -translate-x-1/2 bg-rgsu-900/90 dark:bg-slate-800/90 text-white px-6 py-3 rounded-full shadow-2xl z-[45] hidden flex items-center gap-4 animate-fade-in backdrop-blur-md border border-white/10 ring-1 ring-black/5 active:scale-[0.99] transition-transform noise-bg">
        <span class="font-bold text-sm flex items-center gap-2 relative z-10"><div class="w-2 h-2 rounded-full bg-accent animate-pulse"></div> <span id="compareCount">0</span> выбрано</span>
        <div class="h-4 w-px bg-white/20 relative z-10"></div>
        <button onclick="openCompareModal()" class="bg-white/20 hover:bg-white/30 px-5 py-1.5 rounded-full text-xs font-bold transition uppercase tracking-wide relative z-10">Сравнить</button>
        <button onclick="clearCompare()" class="text-white/50 hover:text-white hover:bg-white/10 p-1 rounded-full transition relative z-10"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed top-24 right-6 z-50 flex flex-col gap-3 pointer-events-none max-w-[90vw] md:max-w-sm"></div>

    <!-- Mobile Bottom Navigation -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-lg border-t border-slate-200 dark:border-slate-800 z-50 flex justify-around items-center h-[calc(3.5rem+env(safe-area-inset-bottom))] pb-safe shadow-[0_-4px_20px_-4px_rgba(0,0,0,0.1)]">
        <button onclick="scrollToTop()" class="flex flex-col items-center justify-center w-full h-full text-slate-400 dark:text-slate-500 active:text-rgsu-700 dark:active:text-white space-y-1 transition-colors">
            <i data-lucide="search" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Поиск</span>
        </button>
        <button onclick="toggleMobileSheet()" class="flex flex-col items-center justify-center w-full h-full text-slate-400 dark:text-slate-500 active:text-rgsu-700 dark:active:text-white space-y-1 transition-colors">
            <i data-lucide="sliders-horizontal" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Фильтры</span>
        </button>
        <button onclick="toggleFavFilter()" class="flex flex-col items-center justify-center w-full h-full text-slate-400 dark:text-slate-500 active:text-rgsu-700 dark:active:text-white space-y-1 relative transition-colors">
            <i data-lucide="heart" class="w-6 h-6"></i>
            <span class="text-[10px] font-medium">Избранное</span>
            <div id="mobileFavDot" class="hidden absolute top-2 right-6 w-2 h-2 bg-red-500 rounded-full ring-2 ring-white dark:ring-slate-900"></div>
        </button>
        <button onclick="toggleTheme()" class="flex flex-col items-center justify-center w-full h-full text-slate-400 dark:text-slate-500 active:text-rgsu-700 dark:active:text-white space-y-1 transition-colors">
            <i data-lucide="moon" class="w-6 h-6 hidden dark:block"></i>
            <i data-lucide="sun" class="w-6 h-6 block dark:hidden"></i>
            <span class="text-[10px] font-medium">Тема</span>
        </button>
    </div>

    <!-- Mobile Filters Sheet -->
    <div id="mobileSheet" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="toggleMobileSheet()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white dark:bg-slate-900 rounded-t-3xl p-6 pb-safe shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[85vh] overflow-y-auto flex flex-col" id="mobileSheetContent">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-6 shrink-0"></div>
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h3 class="font-bold text-xl text-slate-900 dark:text-white">Фильтры</h3>
                <button onclick="toggleMobileSheet()" class="p-2 bg-slate-50 dark:bg-slate-800 rounded-full text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="mobileFiltersContainer" class="space-y-6 flex-grow"></div>
            <button onclick="toggleMobileSheet()" class="w-full bg-rgsu-700 text-white font-bold py-4 rounded-xl mt-6 shadow-lg shadow-rgsu-900/20 active:scale-95 transition-transform shrink-0">Применить</button>
        </div>
    </div>

    <!-- Modals & Scripts (Same as before) -->
    <div id="modal" class="fixed inset-0 z-[100] hidden" role="dialog">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto p-0 md:p-4 flex items-end md:items-center justify-center">
            <div class="relative bg-white dark:bg-slate-800 rounded-t-3xl md:rounded-3xl shadow-2xl w-full md:max-w-2xl transform transition-all scale-100 md:scale-95 opacity-0 overflow-hidden border-0 md:border border-slate-200 dark:border-slate-700 min-h-[80vh] md:min-h-auto" id="modalPanel">
                <button onclick="closeModal()" class="absolute top-4 right-4 p-2 rounded-full bg-white/80 dark:bg-slate-700/80 hover:bg-slate-100 dark:hover:bg-slate-600 z-10 transition dark:text-white no-print"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div id="modalContent" class="p-6 md:p-8 max-h-[85vh] overflow-y-auto custom-scrollbar pb-24 md:pb-8"></div>
            </div>
        </div>
    </div>

    <div id="compareModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="document.getElementById('compareModal').classList.add('hidden')"></div>
        <div class="fixed inset-0 z-10 overflow-auto p-4 flex items-center justify-center">
            <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-6xl p-8 overflow-hidden flex flex-col max-h-[90vh] border border-slate-200 dark:border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Сравнение программ</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Сравните условия и выберите лучшее</p>
                    </div>
                    <button onclick="document.getElementById('compareModal').classList.add('hidden')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition dark:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 p-3 rounded-xl mb-4 text-xs text-blue-800 dark:text-blue-300 flex items-center gap-2 font-medium">
                    <i data-lucide="info" class="w-4 h-4"></i> Различия в параметрах выделены цветом
                </div>
                <div class="overflow-auto flex-grow custom-scrollbar border border-slate-100 dark:border-slate-800 rounded-xl relative">
                    <div id="compareContent" class="min-w-max"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let allPrograms = [];
        let filteredPrograms = [];
        let visibleCount = 21;
        let showFavorites = false;
        let layoutMode = 'grid';
        let searchHistory = JSON.parse(localStorage.getItem('rgsu_search_history') || '[]');
        let recentlyViewed = JSON.parse(localStorage.getItem('rgsu_recent') || '[]');
        
        const initialState = { level: 'all', search: '', region: '', university: '', budget: false, sort: 'default' };
        let filters = { ...initialState };
        const favorites = JSON.parse(localStorage.getItem('rgsu_favs') || '[]');
        const compareList = new Set();
        const SHEET_ID = '12GNjcomxxU4NbXKwQ1Jq_eG7M7PLUlDlKAnBO4qwu5g';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            const savedView = localStorage.getItem('rgsu_view_mode');
            if(savedView === 'list') layoutMode = 'list';
            updateLayoutIcon();
            readURL(); 
            loadData();
            updateFavBadge(); 
            
            document.addEventListener('mousemove', (e) => {
                const x = e.clientX / window.innerWidth;
                const y = e.clientY / window.innerHeight;
                const blob1 = document.getElementById('heroBlob1');
                const blob2 = document.getElementById('heroBlob2');
                if(blob1) blob1.style.transform = `translate(${x * 30}px, ${y * 30}px) scale(1.1)`;
                if(blob2) blob2.style.transform = `translate(-${x * 30}px, -${y * 30}px) scale(1.1)`;
            });

            window.addEventListener('popstate', () => {
                const hash = window.location.hash;
                if (!hash.startsWith('#program=')) {
                    document.getElementById('modal').classList.add('hidden');
                    document.body.style.overflow = '';
                } else {
                    const id = parseInt(hash.split('=')[1]);
                    if(!isNaN(id)) openModal(id, false);
                }
            });

            if (window.location.hash.startsWith('#program=')) {
                const id = parseInt(window.location.hash.split('=')[1]);
                if (!isNaN(id)) setTimeout(() => openModal(id), 500);
            }

            const observer = new IntersectionObserver((entries) => {
                if(entries[0].isIntersecting) loadMore();
            }, { rootMargin: '100px' });
            const sentinel = document.getElementById('sentinel');
            if(sentinel) observer.observe(sentinel);

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.getElementById('compareModal').classList.add('hidden');
                    blurSearch();
                }
            });
        });

        document.getElementById('searchInput').addEventListener('input', (e) => { 
            const btn = document.getElementById('clearSearchBtn');
            if (e.target.value) btn.classList.remove('hidden'); else btn.classList.add('hidden');
            updateFilters(); 
        });
        
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                saveSearchHistory(e.target.value);
                document.getElementById('searchInput').blur();
            }
        });

        // Mobile Filter Sheet Logic (Robust Sync)
        function toggleMobileSheet() {
            const sheet = document.getElementById('mobileSheet');
            const content = document.getElementById('mobileSheetContent');
            const container = document.getElementById('mobileFiltersContainer');
            
            if (sheet.classList.contains('hidden')) {
                // Open & Render Filters
                container.innerHTML = ''; 
                
                // 1. Levels
                const levelWrapper = document.createElement('div');
                levelWrapper.innerHTML = `<label class="block text-sm font-bold mb-2 text-slate-700 dark:text-slate-300">Уровень образования</label>`;
                const levelsDiv = document.createElement('div');
                levelsDiv.className = "flex gap-2 overflow-x-auto pb-2 no-scrollbar";
                ['all', ...new Set(allPrograms.map(p => p.level))].forEach(l => {
                   const isAct = filters.level === l;
                   const label = l === 'all' ? 'Все' : (l === 'SPO' ? 'Колледж' : 'ВУЗ');
                   levelsDiv.innerHTML += `<button onclick="setFilter('level', '${l}'); toggleMobileSheet()" class="px-4 py-2 rounded-xl text-sm font-bold whitespace-nowrap border ${isAct ? 'bg-rgsu-900 text-white border-rgsu-900 dark:bg-blue-600 dark:border-blue-600' : 'bg-white dark:bg-slate-800 text-slate-500 dark:text-slate-400 border-slate-200 dark:border-slate-700'}">${label}</button>`;
                });
                levelWrapper.appendChild(levelsDiv);
                container.appendChild(levelWrapper);

                // 2. Region
                const regionWrap = document.createElement('div');
                regionWrap.innerHTML = `<label class="block text-sm font-bold mb-2 text-slate-700 dark:text-slate-300">Регион</label>`;
                const regSelect = document.createElement('select');
                regSelect.className = "w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-rgsu-600 dark:text-white appearance-none";
                regSelect.innerHTML = `<option value="">Все регионы</option>` + [...new Set(allPrograms.map(p => p.region).filter(r => r && r !== "РФ"))].sort().map(r => `<option value="${r}" ${filters.region === r ? 'selected' : ''}>${r}</option>`).join('');
                regSelect.addEventListener('change', (e) => { document.getElementById('regionInput').value = e.target.value; updateFilters(); });
                regionWrap.appendChild(regSelect);
                container.appendChild(regionWrap);

                // 3. University
                const uniWrap = document.createElement('div');
                uniWrap.innerHTML = `<label class="block text-sm font-bold mb-2 text-slate-700 dark:text-slate-300">Учебное заведение</label>`;
                const uniInput = document.createElement('input');
                uniInput.className = "w-full bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-rgsu-600 dark:text-white";
                uniInput.placeholder = "Название...";
                uniInput.value = filters.university;
                uniInput.addEventListener('change', (e) => { document.getElementById('universityInput').value = e.target.value; updateFilters(); });
                uniWrap.appendChild(uniInput);
                container.appendChild(uniWrap);
                
                // 4. Budget
                const budgetWrap = document.createElement('div');
                budgetWrap.className = "flex items-center justify-between pt-4 border-t border-slate-100 dark:border-slate-700";
                budgetWrap.innerHTML = `<span class="text-base font-bold text-slate-700 dark:text-slate-200">Только бюджет</span>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" class="sr-only peer" id="mobBudget" ${filters.budget ? 'checked' : ''}>
                  <div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-rgsu-600"></div>
                </label>`;
                budgetWrap.querySelector('input').addEventListener('change', (e) => { document.getElementById('budgetToggle').checked = e.target.checked; updateFilters(); });
                container.appendChild(budgetWrap);

                sheet.classList.remove('hidden');
                setTimeout(() => content.classList.remove('translate-y-full'), 10);
            } else {
                content.classList.add('translate-y-full');
                setTimeout(() => sheet.classList.add('hidden'), 300);
            }
        }

        // [Existing helper functions - minified to save space but logic preserved]
        function focusSearch() { document.getElementById('searchOverlay').classList.add('active'); document.getElementById('searchContainer').classList.add('relative', 'z-50', 'scale-105'); renderSearchHistory(); }
        function blurSearch() { document.getElementById('searchOverlay').classList.remove('active'); document.getElementById('searchContainer').classList.remove('relative', 'z-50', 'scale-105'); document.getElementById('searchHistoryDropdown').classList.add('hidden'); }
        function saveSearchHistory(t){if(!t||t.length<3)return;if(!searchHistory.includes(t)){searchHistory.unshift(t);if(searchHistory.length>5)searchHistory.pop();localStorage.setItem('rgsu_search_history',JSON.stringify(searchHistory))}}
        function renderSearchHistory(){const l=document.getElementById('historyList'),d=document.getElementById('searchHistoryDropdown');if(searchHistory.length===0){d.classList.add('hidden');return}d.innerHTML=`<div class="px-4 py-2 text-xs text-slate-400 font-bold uppercase tracking-wider bg-slate-50 dark:bg-slate-900/50">История</div><div id="historyListContent"></div>`;document.getElementById('historyListContent').innerHTML=searchHistory.map(t=>`<div class="px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-3 text-sm text-slate-700 dark:text-slate-300 transition" onclick="setSearchFromHistory('${t}')"><i data-lucide="clock" class="w-4 h-4 text-slate-400"></i> ${t}</div>`).join('');d.classList.remove('hidden');lucide.createIcons()}
        function renderSuggestions(m,q){const d=document.getElementById('searchHistoryDropdown');if(m.length===0){d.classList.add('hidden');return}d.innerHTML=`<div class="px-4 py-2 text-xs text-slate-400 font-bold uppercase tracking-wider bg-slate-50 dark:bg-slate-900/50">Результаты</div><div id="suggestionsContent"></div>`;document.getElementById('suggestionsContent').innerHTML=m.map(p=>`<div class="px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-3 text-sm text-slate-700 dark:text-slate-300 transition" onclick="openModal(${p.id})"><i data-lucide="search" class="w-4 h-4 text-slate-400"></i><div><div class="font-bold">${highlight(p.title,q)}</div><div class="text-xs text-slate-500">${p.inst}</div></div></div>`).join('');d.classList.remove('hidden');lucide.createIcons()}
        function setSearchFromHistory(t){const i=document.getElementById('searchInput');i.value=t;document.getElementById('clearSearchBtn').classList.remove('hidden');updateFilters();blurSearch()}
        function addToRecent(id){recentlyViewed=recentlyViewed.filter(x=>x!==id);recentlyViewed.unshift(id);if(recentlyViewed.length>8)recentlyViewed.pop();localStorage.setItem('rgsu_recent',JSON.stringify(recentlyViewed));renderRecentlyViewed()}
        function renderRecentlyViewed(){const c=document.getElementById('recentlyViewedSection'),l=document.getElementById('recentlyViewedList');if(recentlyViewed.length===0){c.classList.add('hidden');return}c.classList.remove('hidden');const i=recentlyViewed.map(id=>allPrograms.find(p=>p.id===id)).filter(p=>p);l.innerHTML=i.map(p=>`<div class="min-w-[200px] bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 cursor-pointer hover:shadow-md transition" onclick="openModal(${p.id})"><div class="text-[10px] text-slate-400 uppercase font-bold mb-1 truncate">${p.level==='VO'?'ВУЗ':'СПО'}</div><div class="font-bold text-slate-800 dark:text-slate-200 text-sm line-clamp-2 leading-tight mb-2">${p.title}</div><div class="text-xs text-slate-500 dark:text-slate-400 truncate">${p.inst}</div></div>`).join('')}
        function animateValue(o,s,e,d){let st=null;const step=(t)=>{if(!st)st=t;const p=Math.min((t-st)/d,1);o.innerHTML=Math.floor(p*(e-s)+s);if(p<1)window.requestAnimationFrame(step)};window.requestAnimationFrame(step)}
        function initTheme(){if(localStorage.theme==='dark'||(!('theme'in localStorage)&&window.matchMedia('(prefers-color-scheme: dark)').matches))document.documentElement.classList.add('dark');else document.documentElement.classList.remove('dark')}
        function toggleTheme(){if(document.documentElement.classList.contains('dark')){document.documentElement.classList.remove('dark');localStorage.theme='light'}else{document.documentElement.classList.add('dark');localStorage.theme='dark'}}
        function stringToColor(s){let h=0;for(let i=0;i<s.length;i++){h=s.charCodeAt(i)+((h<<5)-h)}const c=(h&0x00FFFFFF).toString(16).toUpperCase();return'#'+"00000".substring(0,6-c.length)+c}
        function generateAvatar(t){const c=stringToColor(t),i=t.substring(0,2).toUpperCase();return`<div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-xs shrink-0 shadow-sm" style="background-color: ${c}">${i}</div>`}
        async function loadData(){try{const r=await fetch(CSV_URL);if(!r.ok)throw new Error('Err');const t=await r.text(),res=Papa.parse(t,{header:true,skipEmptyLines:true});allPrograms=res.data.map((row,i)=>{const b=row['budget_seats']||"",hb=b.toLowerCase().includes('есть')||b.toLowerCase().includes('мест'),m=row['macrogroup_name']||"Общее",bm=b.match(/\d+/),rb=bm?parseInt(bm[0]):(hb?1:0),n=b.includes('2025')||row['program_name'].includes('2025');return{id:i,title:row['program_name']||"Без названия",code:(row['fgos_code']||"").replace(/^\d{4}-\d{2}-\d{2}$/,"Код"),inst:row['institution_name']||"Учебное заведение не указано",region:row['region']||"РФ",level:(row['education_level']||"").toUpperCase().includes('СПО')?'SPO':'VO',cat:m,hasBudget:hb,places:b,url:row['url']||"#",desc:`${row['program_name']}. ${m}.`,color:getCatColor(m),icon:getCatIcon(m),rawBudget:rb,isNew:n}});const tp=allPrograms.length,tu=new Set(allPrograms.map(p=>p.inst)).size;animateValue(document.getElementById("statsPrograms"),0,tp,1500);animateValue(document.getElementById("statsUnis"),0,tu,1500);initUI();applyFilters();renderRecentlyViewed()}catch(e){console.error(e);document.getElementById('catalogGrid').innerHTML=`<div class="col-span-3 text-center py-20 text-red-500">Ошибка загрузки.</div>`}}
        function initUI(){const l=document.getElementById('levelButtons');if(l){l.innerHTML=`<button onclick="setFilter('level','all')" id="lvl-all" class="px-5 py-2.5 rounded-xl text-sm font-bold transition whitespace-nowrap active:scale-95">Все</button>`+[...new Set(allPrograms.map(p=>p.level))].sort().map(v=>`<button onclick="setFilter('level','${v}')" id="lvl-${v}" class="px-5 py-2.5 rounded-xl text-sm font-bold transition whitespace-nowrap active:scale-95">${v==='SPO'?'Колледж':'ВУЗ'}</button>`).join('')}const dl=document.getElementById('regions');if(dl)[...new Set(allPrograms.map(p=>p.region).filter(r=>r&&r!=="РФ"))].sort().forEach(r=>dl.appendChild(new Option(r)));const ud=document.getElementById('universities');if(ud)[...new Set(allPrograms.map(p=>p.inst).filter(i=>i&&i!=="Учебное заведение не указано"))].sort().forEach(u=>ud.appendChild(new Option(u)));const pd=document.getElementById('popularFilters');if(pd){const c=allPrograms.map(p=>p.cat),cnt={};c.forEach(x=>{cnt[x]=(cnt[x]||0)+1});const tc=Object.keys(cnt).sort((a,b)=>cnt[b]-cnt[a]).slice(0,5);pd.innerHTML=tc.map(c=>`<div onclick="document.getElementById('searchInput').value='${c}';updateFilters()" class="flex-shrink-0 w-32 bg-white dark:bg-slate-800 rounded-xl p-3 cursor-pointer hover:shadow-lg transition border border-slate-100 dark:border-slate-700 flex flex-col items-center text-center gap-2 snap-center group"><div class="w-10 h-10 rounded-full bg-rgsu-50 dark:bg-slate-700 text-rgsu-600 dark:text-blue-300 flex items-center justify-center group-hover:scale-110 transition"><i data-lucide="${getCatIcon(c)}" class="w-5 h-5"></i></div><span class="text-xs font-bold text-slate-700 dark:text-slate-200 line-clamp-2">${c}</span></div>`).join('')}const s=document.getElementById('searchInput');if(s)s.value=filters.search;const ri=document.getElementById('regionInput');if(ri)ri.value=filters.region;const ui=document.getElementById('universityInput');if(ui)ui.value=filters.university;const bt=document.getElementById('budgetToggle');if(bt)bt.checked=filters.budget;const ss=document.getElementById('sortSelect');if(ss)ss.value=filters.sort;if(filters.search)document.getElementById('clearSearchBtn')?.classList.remove('hidden');if(filters.region){document.getElementById('clearRegionBtn')?.classList.remove('hidden');document.getElementById('regionIcon')?.classList.add('hidden')}if(filters.university){document.getElementById('clearUniBtn')?.classList.remove('hidden');document.getElementById('uniIcon')?.classList.add('hidden')}}
        function updateURL(){const p=new URLSearchParams();if(filters.level!=='all')p.set('level',filters.level);if(filters.search)p.set('q',filters.search);if(filters.region)p.set('region',filters.region);if(filters.university)p.set('uni',filters.university);if(filters.budget)p.set('budget','1');if(filters.sort!=='default')p.set('sort',filters.sort);try{window.history.replaceState({},'',`${window.location.pathname}${p.toString()?'?'+p.toString():''}${window.location.hash}`)}catch(e){}}
        function readURL(){const p=new URLSearchParams(window.location.search);if(p.has('level'))filters.level=p.get('level');if(p.has('q'))filters.search=p.get('q');if(p.has('region'))filters.region=p.get('region');if(p.has('uni'))filters.university=p.get('uni');if(p.has('budget'))filters.budget=true;if(p.has('sort'))filters.sort=p.get('sort')}
        function setFilter(k,v){filters[k]=v;updateFilters()}
        function resetAllFilters(){filters={...initialState};document.getElementById('searchInput').value='';document.getElementById('regionInput').value='';document.getElementById('universityInput').value='';document.getElementById('budgetToggle').checked=false;document.getElementById('sortSelect').value='default';updateFilters()}
        function updateFilters(){const s=document.getElementById('searchInput');if(s)filters.search=s.value.toLowerCase();const r=document.getElementById('regionInput');if(r)filters.region=r.value;const u=document.getElementById('universityInput');if(u)filters.university=u.value;const b=document.getElementById('budgetToggle');if(b)filters.budget=b.checked;const so=document.getElementById('sortSelect');if(so)filters.sort=so.value;const rb=document.getElementById('clearRegionBtn'),ri=document.getElementById('regionIcon');if(filters.region){rb?.classList.remove('hidden');ri?.classList.add('hidden')}else{rb?.classList.add('hidden');ri?.classList.remove('hidden')}const ub=document.getElementById('clearUniBtn'),ui=document.getElementById('uniIcon');if(filters.university){ub?.classList.remove('hidden');ui?.classList.add('hidden')}else{ub?.classList.add('hidden');ui?.classList.remove('hidden')}const gb=document.getElementById('globalResetBtn');const id=!filters.search&&!filters.region&&!filters.university&&!filters.budget&&filters.level==='all';if(gb)id?gb.classList.add('hidden'):gb.classList.remove('hidden');updateURL();applyFilters(true)}
        function applyFilters(rc=false){if(rc)visibleCount=21;filteredPrograms=allPrograms.filter(p=>{if(showFavorites&&!favorites.includes(p.id))return false;const ms=p.title.toLowerCase().includes(filters.search)||p.cat.toLowerCase().includes(filters.search)||p.inst.toLowerCase().includes(filters.search);const ml=filters.level==='all'||p.level===filters.level;const mr=!filters.region||p.region===filters.region;const mu=!filters.university||p.inst===filters.university;const mb=!filters.budget||p.hasBudget;return ms&&ml&&mr&&mu&&mb});if(filters.sort==='budget_desc')filteredPrograms.sort((a,b)=>b.rawBudget-a.rawBudget);else if(filters.sort==='name_asc')filteredPrograms.sort((a,b)=>a.title.localeCompare(b.title));else if(filters.sort==='region_asc')filteredPrograms.sort((a,b)=>a.region.localeCompare(b.region));renderUI()}
        function renderUI(){document.querySelectorAll('#levelButtons button').forEach(b=>{const ia=b.id===`lvl-${filters.level}`;b.className=ia?"px-5 py-2.5 rounded-xl text-sm font-bold transition bg-rgsu-900 text-white shadow-lg shadow-rgsu-900/20 whitespace-nowrap ring-2 ring-transparent focus:ring-rgsu-600 focus:ring-offset-2 dark:bg-blue-600 dark:shadow-none active:scale-95":"px-5 py-2.5 rounded-xl text-sm font-bold transition text-slate-500 bg-white border border-slate-200 hover:bg-slate-50 hover:text-rgsu-900 whitespace-nowrap focus:ring-2 focus:ring-rgsu-600 focus:ring-offset-2 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400 dark:hover:text-white active:scale-95"});const cd=document.getElementById('activeFilters');if(cd){let h='';if(filters.region)h+=createChip(filters.region,()=>{document.getElementById('regionInput').value='';updateFilters()});if(filters.university)h+=createChip(filters.university,()=>{document.getElementById('universityInput').value='';updateFilters()});if(filters.budget)h+=createChip('Бюджет',()=>{document.getElementById('budgetToggle').checked=false;updateFilters()});if(filters.search)h+=createChip(`Поиск: ${filters.search}`,()=>{clearSearch()});cd.innerHTML=h}const rc=document.getElementById('resultsCount');if(rc)rc.innerText=`Найдено: ${filteredPrograms.length}`;const g=document.getElementById('catalogGrid'),sp=document.getElementById('loadingSpinner');if(!g)return;if(layoutMode==='list')g.classList.add('layout-list');else g.classList.remove('layout-list');const q=filters.search.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');if(filteredPrograms.length===0){g.innerHTML=`<div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-20 flex flex-col items-center animate-fade-in"><div class="w-32 h-32 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-inner"><svg class="w-16 h-16 text-slate-300 dark:text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="9" y1="14" x2="15" y2="14"></line></svg></div><h3 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Пусто...</h3><p class="text-slate-500 dark:text-slate-400 mb-8 max-w-sm">По вашему запросу ничего не найдено.</p></div>`;if(sp)sp.classList.add('hidden');return}const d=filteredPrograms.slice(0,visibleCount);let lg='',html='';d.forEach((p,i)=>{if(filters.sort==='region_asc'){if(p.region!==lg){html+=`<div class="col-span-1 md:col-span-2 lg:col-span-3 pt-4 pb-2 animate-fade-in"><h3 class="text-lg font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider border-b border-slate-200 dark:border-slate-700 pb-1">${p.region}</h3></div>`;lg=p.region}}const ifav=favorites.includes(p.id),icomp=compareList.has(p.id),iv=recentlyViewed.includes(p.id),pc=layoutMode==='list'?'p-6':'p-6',del=Math.min(i*50,500),av=p.icon?`<i data-lucide="${p.icon}" class="w-5 h-5"></i>`:generateAvatar(p.cat),wc=layoutMode==='list'?'flex-row items-center gap-6':'flex-col';html+=`<div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm hover:shadow-xl card-hover border border-slate-100 dark:border-slate-700 flex ${wc} ${pc} animate-fade-in relative transition-all duration-300 ${p.color} ${iv?'opacity-90':''} tilt-card" style="animation-delay: ${del}ms; opacity: 0;"><div class="${layoutMode==='list'?'w-full md:w-auto flex-grow':'w-full'} flex-grow cursor-pointer group" onclick="openModal(${p.id})"><div class="flex justify-between items-start mb-2"><div class="flex items-start gap-3"><div class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-slate-400 dark:text-slate-300 shrink-0 group-hover:bg-rgsu-50 dark:group-hover:bg-blue-900/30 group-hover:text-rgsu-600 dark:group-hover:text-blue-400 transition-colors duration-300 card-img relative overflow-hidden">${av}${iv?'<div class="absolute -top-1 -right-1 w-3 h-3 bg-slate-200 dark:bg-slate-600 rounded-full border-2 border-white dark:border-slate-800 flex items-center justify-center"><div class="w-1 h-1 bg-slate-500 rounded-full"></div></div>':''}</div><div><div class="flex flex-wrap gap-2 mb-1"><span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border ${p.level==='VO'?'bg-indigo-50 text-indigo-700 border-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-300 dark:border-indigo-800':'bg-emerald-50 text-emerald-700 border-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-300 dark:border-emerald-800'}">${p.level==='VO'?'ВУЗ':'Колледж'}</span>${p.hasBudget?`<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-green-50 text-green-700 border border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800 flex items-center gap-1 relative overflow-hidden"><div class="absolute inset-0 shimmer-bg"></div><i data-lucide="check-circle-2" class="w-3 h-3 relative z-10"></i> <span class="relative z-10">Бюджет</span></span>`:''}${p.isNew?`<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-purple-50 text-purple-700 border border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800 relative overflow-hidden"><div class="absolute inset-0 shimmer-bg"></div><span class="relative z-10">New 2025</span></span>`:''}</div><h3 class="font-bold text-slate-900 dark:text-white text-lg leading-snug group-hover:text-rgsu-700 dark:group-hover:text-blue-400 transition duration-300">${highlight(p.title,q)}</h3></div></div></div><div class="space-y-1 ml-13 pl-13 md:ml-0 md:pl-0 mt-2"><p class="text-sm text-slate-700 dark:text-slate-300 font-semibold flex items-start gap-2 group/tag" onclick="event.stopPropagation();document.getElementById('universityInput').value='${p.inst}';updateFilters()"><i data-lucide="graduation-cap" class="w-4 h-4 text-slate-400 mt-0.5 shrink-0"></i> <span class="hover:text-rgsu-600 hover:underline transition">${highlight(p.inst,q)}</span></p><p class="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2 group/tag" onclick="event.stopPropagation();document.getElementById('regionInput').value='${p.region}';updateFilters()"><i data-lucide="map-pin" class="w-4 h-4 text-slate-400 shrink-0"></i> <span class="hover:text-rgsu-600 hover:underline transition">${p.region}</span></p></div></div><div class="${layoutMode==='list'?'flex-col border-l border-slate-100 pl-4 ml-4 hidden md:flex min-w-[140px]':'mt-6 pt-4 border-t border-slate-50 dark:border-slate-700 flex items-center justify-between'}"><div class="flex gap-2 ${layoutMode==='list'?'flex-col w-full':''}"><button onclick="toggleFav(${p.id},this)" class="text-slate-300 dark:text-slate-600 hover:text-red-500 dark:hover:text-red-500 transition hover:scale-110 p-1 fav-btn-target active:scale-90 flex items-center gap-2" data-tooltip="В избранное"><i data-lucide="heart" class="w-5 h-5 ${ifav?'fill-red-500 text-red-500':''}"></i> ${layoutMode==='list'?'<span class="text-xs font-bold text-slate-500">В избранное</span>':''}</button><label class="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-400 hover:text-rgsu-700 dark:hover:text-blue-400 select-none transition-colors"><input type="checkbox" class="rounded border-slate-300 dark:border-slate-600 text-rgsu-700 focus:ring-rgsu-600 w-4 h-4 dark:bg-slate-700" ${icomp?'checked':''} onchange="toggleCompare(${p.id})">СРАВНИТЬ</label></div>${layoutMode!=='list'?`<button onclick="openModal(${p.id})" class="text-rgsu-600 dark:text-blue-400 hover:text-rgsu-800 dark:hover:text-blue-300 text-sm font-bold flex items-center gap-1 group/btn active:scale-95 transition">Подробнее <i data-lucide="chevron-right" class="w-4 h-4 group-hover/btn:translate-x-1 transition-transform"></i></button>`:''}</div></div>`});g.innerHTML=html;if(sp){if(visibleCount>=filteredPrograms.length)sp.classList.add('hidden');else sp.classList.remove('hidden')}lucide.createIcons()}
        function createChip(l,cb){return`<button class="bg-rgsu-50 dark:bg-blue-900/30 text-rgsu-700 dark:text-blue-300 px-3 py-1 rounded-lg flex items-center gap-2 hover:bg-rgsu-100 dark:hover:bg-blue-900/50 transition font-medium animate-fade-in active:scale-95" onclick="(${cb})()">${l} <i data-lucide="x" class="w-3 h-3"></i></button>`}
        function loadMore(){if(visibleCount>=filteredPrograms.length)return;visibleCount+=21;renderUI()}
        function updateFavBadge(){const b=document.getElementById('favCountBadge'),md=document.getElementById('mobileFavDot'),eb=document.getElementById('exportFavBtn');if(favorites.length>0){b.innerText=favorites.length;b.classList.remove('hidden');md.classList.remove('hidden');document.title=`(${favorites.length}) РГСУ | Избранное`}else{b.classList.add('hidden');md.classList.add('hidden');document.title='РГСУ | Образовательный портал'}if(showFavorites&&favorites.length>0)eb.classList.remove('hidden');else eb.classList.add('hidden')}
        function toggleFav(id,btn){const idx=favorites.indexOf(id);if(idx===-1){favorites.push(id);const r=btn.getBoundingClientRect();createConfetti(r.left+r.width/2,r.top+r.height/2);showToast('Добавлено в избранное');flyToFav(btn)}else{favorites.splice(idx,1);showToast('Удалено из избранного','info',true,()=>{toggleFav(id,btn)})}localStorage.setItem('rgsu_favs',JSON.stringify(favorites));updateFavBadge();if(showFavorites)applyFilters();else{const i=btn.querySelector('svg');if(favorites.includes(id))i.classList.add('fill-red-500','text-red-500');else i.classList.remove('fill-red-500','text-red-500')}}
        function flyToFav(btn){const h=btn.querySelector('svg').cloneNode(true),sr=btn.getBoundingClientRect(),t=document.getElementById('navHeartIcon');if(!t)return;const tr=t.getBoundingClientRect();h.style.position='fixed';h.style.left=`${sr.left}px`;h.style.top=`${sr.top}px`;h.style.width='20px';h.style.height='20px';h.style.zIndex='100';h.style.pointerEvents='none';h.classList.add('text-red-500','fill-red-500');h.style.setProperty('--tx',`${tr.left-sr.left}px`);h.style.setProperty('--ty',`${tr.top-sr.top}px`);h.style.animation='flyToCart 0.8s cubic-bezier(0.2,0.8,0.2,1) forwards';document.body.appendChild(h);setTimeout(()=>h.remove(),800)}
        function createConfetti(x,y){for(let i=0;i<10;i++){const p=document.createElement('div');p.className='fixed w-2 h-2 rounded-full z-[100] pointer-events-none';p.style.backgroundColor=['#EF4444','#3B82F6','#F59E0B','#10B981'][Math.floor(Math.random()*4)];p.style.left=x+'px';p.style.top=y+'px';const a=Math.random()*Math.PI*2,d=30+Math.random()*50;p.style.setProperty('--x',Math.cos(a)*d+'px');p.style.setProperty('--y',Math.sin(a)*d+'px');p.style.animation='confetti 0.6s ease-out forwards';document.body.appendChild(p);setTimeout(()=>p.remove(),600)}}
        function toggleCompare(id){if(compareList.has(id)){compareList.delete(id);showToast('Убрано из сравнения','info')}else{if(compareList.size>=4){showToast('Максимум 4 программы','info');setTimeout(renderUI,50);return}compareList.add(id);showToast('Добавлено к сравнению')}const b=document.getElementById('compareBar');if(compareList.size>0){b.classList.remove('hidden');b.classList.add('flex');document.getElementById('compareCount').innerText=compareList.size}else{b.classList.add('hidden');b.classList.remove('flex')}}
        function clearCompare(){compareList.clear();toggleCompare(0);renderUI()}
        function clearUniversity(){document.getElementById('universityInput').value='';updateFilters()}
        function exportFavoritesCSV(){const items=allPrograms.filter(p=>favorites.includes(p.id));if(items.length===0)return;const h=["Название","Учебное заведение","Регион","Уровень","Бюджет","Ссылка"],r=items.map(p=>[`"${p.title.replace(/"/g,'""')}"`,`"${p.inst.replace(/"/g,'""')}"`,`"${p.region}"`,p.level==='VO'?'ВУЗ':'СПО',`"${p.places}"`,p.url]),c="\uFEFF"+[h.join(','),...r.map(x=>x.join(','))].join('\n'),b=new Blob([c],{type:'text/csv;charset=utf-8;'}),u=URL.createObjectURL(b),l=document.createElement("a");l.setAttribute("href",u);l.setAttribute("download","rgsu_favorites.csv");document.body.appendChild(l);l.click();document.body.removeChild(l);showToast('Файл скачан')}
        function scrollToTop(){window.scrollTo({top:0,behavior:'smooth'})}
        function clearSearch(){document.getElementById('searchInput').value='';blurSearch();updateFilters()}
        function clearRegion(){document.getElementById('regionInput').value='';updateFilters()}
        function showToast(msg,type='success',undo=false,cb=null){const c=document.getElementById('toastContainer');if(!c)return;const t=document.createElement('div'),i=type==='success'?'check-circle':'info',cl=type==='success'?'bg-emerald-600':'bg-slate-800 dark:bg-slate-700';t.className=`${cl} text-white px-5 py-4 rounded-xl shadow-xl flex items-center gap-3 animate-toast pointer-events-auto min-w-[240px] border border-white/10 backdrop-blur-md justify-between`;let h=`<div class="flex items-center gap-2"><i data-lucide="${i}" class="w-5 h-5"></i> <span class="text-sm font-bold tracking-wide">${msg}</span></div>`;if(undo)h+=`<button id="undoBtn" class="text-xs uppercase font-bold underline opacity-80 hover:opacity-100">Отмена</button>`;t.innerHTML=h;c.appendChild(t);lucide.createIcons();if(undo&&cb){t.querySelector('#undoBtn').onclick=()=>{cb();t.remove()}}setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(100%)';setTimeout(()=>t.remove(),300)},3000)}
        function highlight(t,q){if(!q)return t;const r=new RegExp(`(${q})`,'gi');return t.replace(r,'<mark class="bg-yellow-200 dark:bg-yellow-500/50 dark:text-white text-slate-900 rounded-sm px-0.5">$1</mark>')}
        function toggleCompactMode(r=true){if(r)toggleLayout()}
        function toggleLayout(){layoutMode=layoutMode==='grid'?'list':'grid';localStorage.setItem('rgsu_view_mode',layoutMode);updateLayoutIcon();renderUI()}
        function updateLayoutIcon(){const b=document.getElementById('layoutToggleBtn');if(!b)return;const i=layoutMode==='grid'?'layout-grid':'list';b.innerHTML=`<i data-lucide="${i}" class="w-5 h-5"></i>`;if(layoutMode==='list'){b.classList.add('bg-slate-100','text-rgsu-900','dark:bg-slate-700','dark:text-white');b.classList.remove('text-slate-400')}else{b.classList.remove('bg-slate-100','text-rgsu-900','dark:bg-slate-700','dark:text-white');b.classList.add('text-slate-400')}lucide.createIcons()}
        function getCatColor(c){c=c.toLowerCase();if(c.includes('it'))return'border-l-4 border-l-blue-500 dark:border-l-blue-400';if(c.includes('педагог'))return'border-l-4 border-l-orange-400';if(c.includes('медиц'))return'border-l-4 border-l-red-400';if(c.includes('инжен'))return'border-l-4 border-l-slate-500 dark:border-l-slate-400';return'border-l-4 border-l-indigo-200 dark:border-l-indigo-700'}
        function getCatIcon(c){c=c.toLowerCase();if(c.includes('it'))return'monitor';if(c.includes('педагог'))return'book-open';if(c.includes('медиц'))return'activity';return'graduation-cap'}
        function openModal(id,ph=true){const p=allPrograms.find(x=>x.id===id);if(!p)return;if(ph)try{history.pushState({modalId:id},'',`#program=${id}`);document.title=`${p.title} - РГСУ Портал`}catch(e){}addToRecent(id);const isFav=favorites.includes(p.id),sim=allPrograms.filter(x=>x.cat===p.cat&&x.level===p.level&&x.id!==p.id).slice(0,3);let sh='';if(sim.length>0){sh=`<div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 no-print"><h4 class="font-bold text-slate-800 dark:text-white mb-4">Похожие программы</h4><div class="grid grid-cols-1 sm:grid-cols-3 gap-3">${sim.map(s=>`<div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl border border-slate-100 dark:border-slate-600 cursor-pointer hover:shadow-md transition" onclick="openModal(${s.id})"><div class="text-[10px] text-slate-400 uppercase font-bold mb-1 truncate">${s.inst}</div><div class="font-bold text-sm text-slate-800 dark:text-white line-clamp-2 leading-tight">${s.title}</div></div>`).join('')}</div></div>`}document.getElementById('modalContent').innerHTML=`<div class="flex justify-between items-start mb-8"><div class="flex items-start gap-5"><div class="w-16 h-16 bg-gradient-to-br from-rgsu-50 to-white dark:from-slate-700 dark:to-slate-800 border border-rgsu-100 dark:border-slate-600 rounded-2xl flex items-center justify-center text-rgsu-700 dark:text-blue-300 shrink-0 shadow-lg shadow-rgsu-900/5 no-print">${p.icon?`<i data-lucide="${p.icon}" class="w-8 h-8"></i>`:`<span class="text-2xl font-bold">${p.title[0]}</span>`}</div><div><div class="flex flex-wrap gap-2 mb-3"><span class="px-2.5 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 flex items-center gap-1"><i data-lucide="graduation-cap" class="w-3 h-3"></i> ${p.level==='VO'?'Высшее':'СПО'}</span><span class="px-2.5 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 font-mono flex items-center gap-1"><i data-lucide="hash" class="w-3 h-3"></i> ${p.code}</span></div><h2 class="text-2xl sm:text-3xl font-extrabold leading-tight text-slate-900 dark:text-white mb-2">${p.title}</h2><p class="text-rgsu-700 dark:text-blue-400 font-bold text-lg flex items-center gap-2"><i data-lucide="building-2" class="w-5 h-5"></i> ${p.inst}</p></div></div><button class="no-print p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400" onclick="generateQR('${window.location.href}')" data-tooltip="QR-код"><i data-lucide="qr-code" class="w-5 h-5"></i></button></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8"><div class="bg-blue-50/50 dark:bg-slate-900 p-5 rounded-2xl border border-blue-100 dark:border-slate-600"><div class="text-xs text-blue-400 uppercase font-bold mb-2 tracking-wider">Места и Бюджет</div><div class="font-bold text-slate-800 dark:text-white text-xl">${p.places}</div>${p.hasBudget?'<div class="mt-3 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 font-bold text-sm"><i data-lucide="check-circle-2" class="w-4 h-4"></i> Бюджет</div>':''}</div><div class="bg-slate-50 dark:bg-slate-900 p-5 rounded-2xl border border-slate-100 dark:border-slate-600"><div class="text-xs text-slate-400 uppercase font-bold mb-2 tracking-wider">Локация</div><div class="font-bold text-slate-800 dark:text-white text-xl flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5 text-slate-400"></i> ${p.region}</div></div></div><div class="prose prose-sm text-slate-600 dark:text-slate-300 mb-8 bg-white dark:bg-transparent p-2"><h4 class="font-bold text-slate-900 dark:text-white mb-3 text-lg">О программе</h4><p class="leading-relaxed text-base">${p.desc}</p></div><div id="qrCodeContainer" class="hidden flex justify-center mb-6 no-print"></div>${sh}<div class="flex gap-3 sticky bottom-0 bg-white/95 dark:bg-slate-800/95 backdrop-blur-sm pt-4 pb-2 border-t border-slate-100 dark:border-slate-700 items-center -mx-4 px-4 sm:mx-0 sm:px-0 no-print"><a href="${p.url}" target="_blank" class="flex-grow text-center bg-rgsu-700 hover:bg-rgsu-800 dark:bg-blue-600 dark:hover:bg-blue-700 text-white py-4 rounded-xl font-bold transition shadow-lg flex justify-center items-center gap-2 active:scale-[0.98]">Перейти на сайт <i data-lucide="external-link" class="w-4 h-4"></i></a><button onclick="shareProgram(${p.id},'${p.title}')" class="w-14 h-14 flex items-center justify-center border border-slate-200 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition active:scale-95" data-tooltip="Поделиться"><i data-lucide="share-2" class="w-6 h-6 text-slate-400"></i></button><button onclick="toggleFav(${p.id},this)" class="w-14 h-14 flex items-center justify-center border border-slate-200 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition active:scale-95" data-tooltip="В избранное"><i data-lucide="heart" class="w-6 h-6 ${favorites.includes(p.id)?'fill-red-500 text-red-500':'text-slate-400'}"></i></button></div>`;const m=document.getElementById('modal');m.classList.remove('hidden');setTimeout(()=>{m.querySelector('div').classList.remove('opacity-0');document.getElementById('modalPanel').classList.remove('scale-95','opacity-0');document.getElementById('modalPanel').classList.add('scale-100','opacity-100')},10);lucide.createIcons()}
        function generateQR(u){const c=document.getElementById('qrCodeContainer');if(!c.classList.contains('hidden')){c.classList.add('hidden');return}c.innerHTML=`<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(u)}" alt="QR" class="rounded-xl border border-slate-200 p-2">`;c.classList.remove('hidden')}
        function shareProgram(id,t){const u=`${window.location.origin}${window.location.pathname}#program=${id}`;const b=event.currentTarget;if(navigator.share){navigator.share({title:t,text:`Посмотри эту программу: ${t}`,url:u}).catch(console.error)}else{navigator.clipboard.writeText(u).then(()=>{showToast('Ссылка скопирована');b.innerHTML=`<i data-lucide="check" class="w-6 h-6 text-green-500"></i>`;lucide.createIcons();setTimeout(()=>{b.innerHTML=`<i data-lucide="share-2" class="w-6 h-6 text-slate-400"></i>`;lucide.createIcons()},2000)})}}
        function closeModal(){const m=document.getElementById('modal');document.getElementById('modalPanel').classList.remove('scale-100','opacity-100');document.getElementById('modalPanel').classList.add('scale-95','opacity-0');setTimeout(()=>{m.classList.add('hidden');try{window.location.hash='';document.title='РГСУ | Образовательный портал'}catch(e){}},200)}
        function openCompareModal(){const items=allPrograms.filter(p=>compareList.has(p.id));if(items.length===0)return;const keys=[{label:"Уровень",val:p=>p.level==='VO'?'ВУЗ':'Колледж'},{label:"Регион",val:p=>p.region},{label:"Бюджет",val:p=>p.places},{label:"Категория",val:p=>p.cat}];const rr=k=>{const v=items.map(p=>k.val(p)),d=new Set(v).size>1;return`<tr class="${d?'diff-row':''}"><td class="p-4 border-b dark:border-slate-700 font-semibold text-slate-500 dark:text-slate-400 sticky left-0 bg-white dark:bg-slate-900 shadow-md z-10 text-sm">${k.label}</td>${items.map(p=>`<td class="p-4 border-b dark:border-slate-700 min-w-[200px] text-sm text-slate-700 dark:text-slate-300">${k.val(p)}</td>`).join('')}</tr>`};document.getElementById('compareContent').innerHTML=`<table class="w-full text-left border-collapse"><thead><tr><th class="p-4 border-b-2 dark:border-slate-600 min-w-[150px] bg-slate-50 dark:bg-slate-800 sticky left-0 z-20 shadow-md text-slate-400 font-bold uppercase text-xs">Параметр</th>${items.map(p=>`<th class="p-4 border-b-2 dark:border-slate-600 min-w-[240px] bg-slate-50/80 dark:bg-slate-800/80 align-top"><div class="text-sm font-bold text-slate-900 dark:text-white leading-tight mb-1 line-clamp-2">${p.title}</div></th>`).join('')}</tr></thead><tbody>${keys.map(k=>rr(k)).join('')}</tbody></table>`;document.getElementById('compareModal').classList.remove('hidden')}
        document.addEventListener('keydown',e=>{if(e.key==="Escape"){closeModal();document.getElementById('compareModal').classList.add('hidden');blurSearch()}});
    </script>
</body>
</html>
