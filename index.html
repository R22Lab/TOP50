<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>РГСУ | Портал образовательных программ</title>
    <meta name="description" content="Единый каталог образовательных программ">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'], body: ['Inter', 'sans-serif'] },
                    colors: {
                        rgsu: { 900: '#002C5F', 800: '#004080', 700: '#0054A6', 600: '#1A6BC2', 50: '#EAF4FF' },
                        accent: { DEFAULT: '#F2994A', hover: '#E68A3E' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out', 'bounce-slow': 'bounce 3s infinite' },
                    keyframes: { fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F8FAFC; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .card-hover:hover { transform: translateY(-6px); box-shadow: 0 20px 25px -5px rgba(0, 84, 166, 0.15); border-color: #0054A6; }
        /* Skeleton */
        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 0.5rem; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800">

    <!-- Navbar -->
    <header class="fixed w-full top-0 z-50 glass-panel border-b border-slate-200/80 shadow-sm" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex items-center justify-between">
            <a href="https://www.rgsu.net" class="flex items-center gap-5">
                <img src="https://upload.wikimedia.org/wikipedia/ru/archive/4/42/20240520114700%21%D0%A0%D0%93%D0%A1%D0%A3_%D0%BB%D0%BE%D0%B3%D0%BE%D1%82%D0%B8%D0%BF.png" alt="Логотип" class="h-12 w-auto">
                <div class="hidden md:block border-l-2 border-rgsu-200 pl-5">
                    <h1 class="font-bold text-rgsu-900 text-sm uppercase">РГСУ</h1>
                    <p class="text-xs text-slate-500 font-medium">Образовательный портал</p>
                </div>
            </a>
            <div class="flex items-center gap-4">
                <a href="tel:+74952556767" class="hidden lg:block font-bold text-rgsu-900">+7 (495) 255-67-67</a>
            </div>
        </div>
    </header>

    <!-- Hero -->
    <div class="bg-rgsu-900 pt-36 pb-20 px-4 relative overflow-hidden text-center">
        <div class="absolute top-0 right-0 w-[800px] h-[800px] bg-rgsu-600/20 rounded-full blur-3xl translate-x-1/3 -translate-y-1/4"></div>
        
        <div class="relative z-10 max-w-4xl mx-auto animate-fade-in">
            <h2 class="text-4xl md:text-6xl font-extrabold text-white mb-6">Образование для <span class="text-blue-200">будущего</span></h2>
            <p class="text-slate-300 mb-10 text-lg">Единый реестр программ переподготовки и высшего образования.</p>
            
            <div class="relative max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-1.5 flex flex-col sm:flex-row gap-2">
                <div class="flex-grow flex items-center px-4">
                    <i data-lucide="search" class="w-5 h-5 text-slate-400"></i>
                    <input type="text" id="searchInput" placeholder="Поиск по профессии, коду или вузу..." class="w-full pl-3 py-3 outline-none bg-transparent">
                </div>
                <button onclick="filterData()" class="bg-accent hover:bg-accent-hover text-white font-bold px-8 py-3 rounded-xl transition-colors">Найти</button>
            </div>

            <!-- Dynamic Popular Filters -->
            <div id="popularFilters" class="flex flex-wrap justify-center gap-3 mt-8 text-sm">
                <!-- JS will inject buttons here -->
                <div class="skeleton w-24 h-8 bg-white/10"></div>
                <div class="skeleton w-24 h-8 bg-white/10"></div>
            </div>
        </div>
    </div>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 -mt-10 pb-20 relative z-20 flex-grow w-full">
        <!-- Controls -->
        <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-4 mb-8 flex flex-col xl:flex-row justify-between gap-4">
            <div class="flex flex-col md:flex-row gap-4 w-full xl:w-auto">
                <!-- Dynamic Level Buttons -->
                <div id="levelButtons" class="flex p-1 bg-slate-100 rounded-xl w-full md:w-auto overflow-x-auto">
                    <!-- JS Injected -->
                </div>
                <!-- Dynamic Regions -->
                <select id="districtFilter" onchange="filterData()" class="w-full md:w-64 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 outline-none cursor-pointer">
                    <option value="all">Все регионы</option>
                </select>
            </div>
            
            <div class="flex items-center justify-between gap-6 w-full xl:w-auto border-t xl:border-none pt-4 xl:pt-0">
                <h3 class="text-sm font-semibold text-slate-600" id="resultsCount">Загрузка...</h3>
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" id="budgetToggle" checked class="peer sr-only" onchange="filterData()">
                    <div class="w-11 h-6 bg-slate-200 rounded-full peer-checked:bg-rgsu-600 peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all relative"></div>
                    <span class="text-sm font-medium text-slate-600">Бюджет</span>
                </label>
            </div>
        </div>

        <!-- Grid -->
        <div id="catalogGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="skeleton h-96"></div><div class="skeleton h-96"></div><div class="skeleton h-96"></div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="bg-slate-900 text-slate-400 py-12 border-t border-slate-800 mt-auto text-sm">
        <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-6">
            <p>© 2025 РГСУ. Официальный портал.</p>
            <div class="flex gap-6">
                <a href="mailto:info@rgsu.net" class="hover:text-white">info@rgsu.net</a>
                <a href="tel:+74952556767" class="hover:text-white">+7 (495) 255-67-67</a>
            </div>
        </div>
    </footer>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 z-[100] hidden" role="dialog">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto p-4 flex items-center justify-center">
            <div class="relative bg-white rounded-2xl shadow-2xl max-w-2xl w-full border-t-4 border-rgsu-700 transform transition-all scale-95 opacity-0" id="modalPanel">
                <button onclick="closeModal()" class="absolute top-4 right-4 p-2 rounded-full hover:bg-slate-100"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div id="modalContent" class="p-6 max-h-[80vh] overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <!-- AI Button -->
    <button onclick="openAiModal()" class="fixed bottom-6 right-6 z-[90] bg-rgsu-700 text-white p-4 rounded-full shadow-lg hover:scale-105 transition-all animate-bounce-slow flex items-center justify-center group">
        <i data-lucide="bot" class="w-7 h-7"></i>
    </button>

    <!-- AI Modal -->
    <div id="aiModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeAiModal()"></div>
        <div class="absolute bottom-0 sm:bottom-auto sm:top-1/2 left-1/2 transform -translate-x-1/2 sm:-translate-y-1/2 w-full sm:w-[600px] h-[80vh] sm:h-[600px] bg-white sm:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col">
            <div class="p-4 border-b flex justify-between bg-slate-50 rounded-t-2xl">
                <h3 class="font-bold">AI-Консультант</h3>
                <button onclick="closeAiModal()"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-6 bg-slate-50/50" id="aiResultContainer">
                <div id="aiInitialState" class="text-center opacity-80 mt-20">
                    <i data-lucide="message-square" class="w-12 h-12 mx-auto text-slate-300 mb-4"></i>
                    <p>Опишите желаемую профессию...</p>
                </div>
                <div id="aiResponseContent" class="hidden prose prose-sm text-slate-700"></div>
            </div>
            <div class="p-4 border-t relative">
                <input type="text" id="aiInput" class="w-full border rounded-xl pl-4 pr-12 py-3" placeholder="Спросить AI...">
                <button onclick="callGeminiAPI()" class="absolute right-6 top-6 text-blue-600"><i data-lucide="send" class="w-5 h-5"></i></button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let programs = [];
        let currentLevel = 'all';
        const SHEET_ID = '12GNjcomxxU4NbXKwQ1Jq_eG7M7PLUlDlKAnBO4qwu5g';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

        // === CORE: LOAD & PROCESS DATA ===
        async function loadData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Err');
                const text = await response.text();
                const results = Papa.parse(text, { header: true, skipEmptyLines: true });
                
                // Optimized Mapping
                programs = results.data.map((row, i) => {
                    const budget = row['budget_seats'] || "";
                    const hasBudget = budget.toLowerCase().includes('есть') || budget.toLowerCase().includes('мест');
                    
                    return {
                        id: i,
                        title: row['program_name'] || "Без названия",
                        code: (row['fgos_code'] || "").replace(/^\d{4}-\d{2}-\d{2}$/, "Код"), // Simple date fix
                        inst: row['institution_name'] || "ВУЗ не указан",
                        region: row['region'] || "РФ",
                        level: normalizeLevel(row['education_level']),
                        cat: row['macrogroup_name'] || "Общее",
                        tags: [hasBudget ? "Бюджет" : "Платное", "2025"],
                        places: budget,
                        url: row['url'] || "#",
                        desc: `${row['program_name']}. ${row['macrogroup_name']}.`
                    };
                });
                
                initFilters();
                filterData();
            } catch (e) {
                document.getElementById('catalogGrid').innerHTML = `<div class="col-span-3 text-center py-20 text-red-500">Ошибка загрузки таблицы</div>`;
            }
        }

        function normalizeLevel(lvl) {
            if (!lvl) return 'VO';
            return lvl.toUpperCase().includes('СПО') ? 'SPO' : 'VO';
        }

        // === DYNAMIC FILTERS GENERATION ===
        function initFilters() {
            // 1. Generate Levels
            const levels = [...new Set(programs.map(p => p.level))].sort();
            const levelContainer = document.getElementById('levelButtons');
            let levelHTML = `<button onclick="setLevel('all')" id="lvl-all" class="px-6 py-2 rounded-lg text-sm font-semibold transition bg-white text-rgsu-900 shadow-sm whitespace-nowrap">Все</button>`;
            
            levels.forEach(l => {
                const label = l === 'SPO' ? 'Колледж (СПО)' : 'ВУЗ (ВО)';
                levelHTML += `<button onclick="setLevel('${l}')" id="lvl-${l}" class="px-6 py-2 rounded-lg text-sm font-semibold transition text-slate-500 hover:text-rgsu-900 whitespace-nowrap">${label}</button>`;
            });
            levelContainer.innerHTML = levelHTML;

            // 2. Generate Regions
            const regions = [...new Set(programs.map(p => p.region).filter(r => r && r !== "РФ"))].sort();
            const regionSelect = document.getElementById('districtFilter');
            regions.forEach(r => {
                regionSelect.add(new Option(r, r));
            });

            // 3. Generate Popular Categories (Top 4)
            const cats = programs.map(p => p.cat);
            const counts = {};
            cats.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
            const topCats = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 4);
            
            const popContainer = document.getElementById('popularFilters');
            popContainer.innerHTML = `<span class="opacity-60 hidden sm:inline self-center">Популярное:</span>` + 
                topCats.map(c => `<button onclick="setSearch('${c}')" class="px-3 py-1.5 rounded-lg bg-white/5 hover:bg-white/10 border border-white/10 hover:text-white transition cursor-pointer">${c}</button>`).join('');
        }

        // === LOGIC ===
        function setLevel(lvl) {
            currentLevel = lvl;
            document.querySelectorAll('#levelButtons button').forEach(b => {
                b.className = b.id === `lvl-${lvl}` ? 
                    "px-6 py-2 rounded-lg text-sm font-semibold transition bg-white text-rgsu-900 shadow-sm whitespace-nowrap" : 
                    "px-6 py-2 rounded-lg text-sm font-semibold transition text-slate-500 hover:text-rgsu-900 whitespace-nowrap";
            });
            filterData();
        }

        function setSearch(val) {
            document.getElementById('searchInput').value = val;
            filterData();
        }

        function filterData() {
            const q = document.getElementById('searchInput').value.toLowerCase();
            const reg = document.getElementById('districtFilter').value;
            const budget = document.getElementById('budgetToggle').checked;

            const res = programs.filter(p => {
                const matchSearch = p.title.toLowerCase().includes(q) || p.cat.toLowerCase().includes(q) || p.inst.toLowerCase().includes(q);
                const matchLvl = currentLevel === 'all' || p.level === currentLevel;
                const matchReg = reg === 'all' || p.region === reg;
                const matchBudg = !budget || p.tags.includes('Бюджет');
                return matchSearch && matchLvl && matchReg && matchBudg;
            });

            renderGrid(res);
        }

        function renderGrid(data) {
            const grid = document.getElementById('catalogGrid');
            document.getElementById('resultsCount').innerHTML = `Найдено: <span class="text-rgsu-700">${data.length}</span>`;
            
            if (!data.length) {
                grid.innerHTML = `<div class="col-span-3 text-center py-20 bg-white rounded-3xl border border-dashed"><p class="text-slate-500">Ничего не найдено</p><button onclick="setSearch(''); setLevel('all')" class="mt-4 text-blue-600 font-bold">Сбросить</button></div>`;
                return;
            }

            grid.innerHTML = data.slice(0, 40).map(p => `
                <div class="bg-white rounded-2xl shadow-sm hover:shadow-lg card-hover border border-slate-100 flex flex-col p-6 animate-fade-in relative cursor-pointer" onclick="openModal(${p.id})">
                    <div class="flex gap-2 mb-3">
                        <span class="px-2 py-1 rounded-md text-[10px] font-bold border ${p.level === 'VO' ? 'bg-indigo-50 text-indigo-700' : 'bg-emerald-50 text-emerald-700'}">${p.level === 'VO' ? 'ВУЗ' : 'СПО'}</span>
                        <span class="px-2 py-1 rounded-md text-[10px] bg-slate-50 border text-slate-500">${p.region}</span>
                    </div>
                    <h3 class="font-bold text-slate-900 mb-2 leading-tight line-clamp-2">${p.title}</h3>
                    <p class="text-xs text-slate-500 mb-4 line-clamp-2">${p.cat}</p>
                    <div class="mt-auto pt-4 border-t flex justify-between text-sm">
                        <div class="truncate max-w-[60%] font-semibold text-slate-700">${p.inst}</div>
                        <div class="font-bold text-rgsu-700">${p.tags.includes('Бюджет') ? 'Бюджет' : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        // === MODALS ===
        function openModal(id) {
            const p = programs.find(x => x.id === id);
            if (!p) return;
            
            document.getElementById('modalContent').innerHTML = `
                <div class="flex items-start gap-4 mb-6">
                    <div class="w-12 h-12 bg-blue-50 rounded-xl flex items-center justify-center text-blue-600"><i data-lucide="graduation-cap"></i></div>
                    <div>
                        <div class="text-xs text-slate-500 mb-1">${p.code} • ${p.level === 'VO' ? 'Высшее' : 'Среднее профессиональное'}</div>
                        <h2 class="text-xl font-bold leading-tight">${p.title}</h2>
                        <p class="text-blue-700 font-semibold mt-1">${p.inst}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3 mb-6">
                    <div class="bg-slate-50 p-3 rounded-lg"><div class="text-xs text-slate-400">Места</div><div class="font-bold">${p.places}</div></div>
                    <div class="bg-slate-50 p-3 rounded-lg"><div class="text-xs text-slate-400">Регион</div><div class="font-bold">${p.region}</div></div>
                </div>
                <div class="prose prose-sm text-slate-600 mb-6 bg-slate-50 p-4 rounded-xl">${p.desc}</div>
                <a href="${p.url}" target="_blank" class="block w-full text-center bg-rgsu-700 text-white py-3 rounded-xl hover:bg-rgsu-600 transition">Перейти на сайт ВУЗа</a>
            `;
            const m = document.getElementById('modal');
            m.classList.remove('hidden');
            setTimeout(() => { 
                m.querySelector('.bg-slate-900\\/60').classList.remove('opacity-0');
                document.getElementById('modalPanel').classList.remove('scale-95', 'opacity-0');
                document.getElementById('modalPanel').classList.add('scale-100', 'opacity-100');
            }, 10);
            lucide.createIcons();
        }

        function closeModal() {
            const m = document.getElementById('modal');
            document.getElementById('modalPanel').classList.remove('scale-100', 'opacity-100');
            document.getElementById('modalPanel').classList.add('scale-95', 'opacity-0');
            setTimeout(() => m.classList.add('hidden'), 200);
        }

        // === AI (Simple Implementation) ===
        const aiModal = document.getElementById('aiModal');
        function openAiModal() { aiModal.classList.remove('hidden'); }
        function closeAiModal() { aiModal.classList.add('hidden'); }
        
        async function callGeminiAPI() {
            const input = document.getElementById('aiInput');
            const q = input.value;
            if(!q) return;
            
            document.getElementById('aiInitialState').classList.add('hidden');
            document.getElementById('aiResponseContent').innerHTML = "Думаю...";
            document.getElementById('aiResponseContent').classList.remove('hidden');
            
            const context = programs.slice(0, 20).map(p => `${p.title} (${p.level}) в ${p.inst}`).join(', ');
            const prompt = `Посоветуй программу из списка: ${context}. Запрос: ${q}`;
            
            // Note: In production, never expose API keys in frontend code
            const apiKey = ""; 
            
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await res.json();
                document.getElementById('aiResponseContent').innerHTML = marked.parse(data.candidates[0].content.parts[0].text);
            } catch(e) {
                document.getElementById('aiResponseContent').innerHTML = "Ошибка AI.";
            }
            input.value = "";
        }

        // Init
        document.addEventListener('DOMContentLoaded', loadData);
        document.addEventListener('keydown', e => { if(e.key === "Escape") { closeModal(); closeAiModal(); } });
    </script>
</body>
</html>
