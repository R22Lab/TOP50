<!DOCTYPE html>
<html lang="ru" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>РГСУ | Образовательный портал</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'], body: ['Inter', 'sans-serif'] },
                    colors: {
                        rgsu: { 900: '#002C5F', 800: '#004080', 700: '#0054A6', 600: '#1A6BC2', 50: '#EAF4FF' },
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', surface: '#1e293b' },
                        accent: { DEFAULT: '#F2994A', hover: '#E68A3E' }
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s ease-out forwards',
                        'toast': 'toastIn 0.3s ease-out forwards',
                        'pulse-soft': 'pulseSoft 2s infinite',
                        'fly': 'flyToCart 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'shimmer': 'shimmer 2s linear infinite',
                        'confetti': 'confetti 0.6s ease-out forwards'
                    },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        toastIn: { '0%': { transform: 'translateX(100%)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        pulseSoft: { '0%, 100%': { opacity: '1' }, '50%': { opacity: '0.7' } },
                        flyToCart: {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '100%': { transform: 'translate(var(--tx), var(--ty)) scale(0.1)', opacity: '0' }
                        },
                        shimmer: {
                            '0%': { backgroundPosition: '-200% 0' },
                            '100%': { backgroundPosition: '200% 0' }
                        },
                        confetti: {
                            '0%': { transform: 'translate(0,0) scale(1)', opacity: '1' },
                            '100%': { transform: 'translate(var(--x), var(--y)) scale(0)', opacity: '0' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #F8FAFC; }
        .dark body { background-color: #0f172a; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .dark .glass-panel { background: rgba(15, 23, 42, 0.95); border-color: rgba(255,255,255,0.1); }

        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid transparent; }
        .card-hover:hover { 
            transform: translateY(-6px) scale(1.01); 
            box-shadow: 0 20px 25px -5px rgba(0, 44, 95, 0.15);
            border-color: #3b82f6; 
        }
        .dark .card-hover:hover { 
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.5); 
            border-color: #60a5fa; 
        }

        .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 0.5rem; }
        .dark .skeleton { background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%); }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        .custom-checkbox:checked { background-color: #0054A6; border-color: #0054A6; background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e"); }
        .sticky-filters { position: sticky; top: 80px; z-index: 30; }
        .diff-row { background-color: #FEF3C7; }
        .dark .diff-row { background-color: #383018; }
        
        #searchOverlay { transition: opacity 0.3s ease, visibility 0.3s ease; }
        #searchOverlay.active { opacity: 1; visibility: visible; }
        
        .custom-scrollbar::-webkit-scrollbar { height: 6px; width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }

        .badge-pop { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop { 0% { transform: scale(0); } 100% { transform: scale(1); } }

        .shimmer-bg {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 3s infinite;
        }

        /* Tooltip */
        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            white-space: nowrap;
            margin-bottom: 6px;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }
        .dark [data-tooltip]:hover::after { background: #cbd5e1; color: #0f172a; }
        
        .layout-list { grid-template-columns: 1fr !important; }
        .layout-list .card-hover { flex-direction: row; align-items: center; padding: 1.5rem; }
        .layout-list .card-img { display: none; }
        @media (max-width: 640px) { .layout-list .card-hover { flex-direction: column; align-items: flex-start; } }

        /* Print Styles */
        @media print {
            body { background: white; color: black; }
            #navbar, #heroSection, #filterPanel, #compareBar, #scrollTopBtn, .md\:hidden, #toastContainer { display: none !important; }
            #modal { position: static; background: white; overflow: visible; height: auto; }
            #modalPanel { box-shadow: none; border: none; transform: none !important; max-width: 100%; }
            #modalContent { overflow: visible; max-height: none; padding: 0; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-800 dark:text-slate-100 font-body transition-colors duration-300 pb-20 md:pb-0">

    <!-- Search Focus Overlay -->
    <div id="searchOverlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-40 opacity-0 invisible" onclick="blurSearch()"></div>

    <!-- Shortcuts Modal -->
    <div id="shortcutsModal" class="fixed inset-0 z-[110] hidden bg-slate-900/80 backdrop-blur-sm flex items-center justify-center p-4" onclick="this.classList.add('hidden')">
        <div class="bg-white dark:bg-slate-800 rounded-2xl p-6 max-w-sm w-full shadow-2xl animate-fade-in" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="keyboard" class="w-5 h-5"></i> Горячие клавиши</h3>
            <div class="space-y-3 text-sm">
                <div class="flex justify-between"><span>Поиск</span> <kbd class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded border border-slate-300 dark:border-slate-600 font-mono text-xs">/</kbd></div>
                <div class="flex justify-between"><span>Закрыть</span> <kbd class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded border border-slate-300 dark:border-slate-600 font-mono text-xs">Esc</kbd></div>
                <div class="flex justify-between"><span>Печать карточки</span> <kbd class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded border border-slate-300 dark:border-slate-600 font-mono text-xs">Ctrl + P</kbd></div>
                <div class="flex justify-between"><span>Справка</span> <kbd class="px-2 py-1 bg-slate-100 dark:bg-slate-700 rounded border border-slate-300 dark:border-slate-600 font-mono text-xs">Shift + ?</kbd></div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <header class="fixed w-full top-0 z-50 glass-panel border-b border-slate-200/80 shadow-sm transition-all duration-300 dark:border-slate-800" id="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <a href="https://www.rgsu.net" class="flex items-center gap-4 group">
                <img src="https://upload.wikimedia.org/wikipedia/ru/archive/4/42/20240520114700%21%D0%A0%D0%93%D0%A1%D0%A3_%D0%BB%D0%BE%D0%B3%D0%BE%D1%82%D0%B8%D0%BF.png" alt="Логотип" class="h-10 w-auto group-hover:scale-105 transition-transform duration-300 bg-white dark:bg-transparent rounded-lg p-0.5">
                <div class="hidden md:block border-l-2 border-rgsu-200 dark:border-slate-700 pl-4">
                    <h1 class="font-bold text-rgsu-900 dark:text-white text-xs uppercase tracking-wide">РГСУ</h1>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 font-medium uppercase">Образование</p>
                </div>
            </a>
            <div class="flex items-center gap-3">
                <button onclick="toggleTheme()" class="hidden md:block p-2 rounded-lg text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800 transition active:scale-95" data-tooltip="Сменить тему">
                    <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
                    <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
                </button>
                <div class="relative hidden md:block">
                    <button onclick="toggleFavFilter()" id="favFilterBtn" class="flex items-center gap-2 px-4 py-2 rounded-xl border border-slate-200 text-slate-600 hover:border-red-300 hover:text-red-500 hover:bg-red-50 dark:border-slate-700 dark:text-slate-300 dark:hover:bg-slate-800 transition-all text-sm font-medium relative group active:scale-95">
                        <i data-lucide="heart" class="w-4 h-4 transition-transform group-active:scale-125" id="navHeartIcon"></i> <span class="hidden sm:inline">Избранное</span>
                        <span id="favCountBadge" class="absolute -top-1.5 -right-1.5 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full shadow-sm hidden badge-pop">0</span>
                    </button>
                    <button onclick="exportFavoritesCSV()" id="exportFavBtn" class="absolute top-12 right-0 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 shadow-xl rounded-xl p-3 w-48 text-left text-sm hidden animate-fade-in z-50 flex items-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-700" data-tooltip="Скачать Excel">
                        <i data-lucide="download" class="w-4 h-4 text-slate-400"></i> Скачать CSV
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Hero with Parallax -->
    <div class="bg-rgsu-900 dark:bg-slate-900 pt-32 pb-16 px-4 relative overflow-hidden text-center transition-colors duration-500" id="heroSection">
        <div class="absolute top-0 right-0 w-[600px] h-[600px] bg-rgsu-600/20 rounded-full blur-3xl translate-x-1/3 -translate-y-1/4 animate-pulse-soft transition-transform duration-100 ease-out" id="heroBlob1"></div>
        <div class="absolute bottom-0 left-0 w-[400px] h-[400px] bg-accent/10 rounded-full blur-3xl -translate-x-1/3 translate-y-1/4 transition-transform duration-100 ease-out" id="heroBlob2"></div>
        
        <div class="relative z-10 max-w-4xl mx-auto animate-fade-in">
            <h2 class="text-3xl md:text-5xl font-extrabold text-white mb-6 leading-tight">Найди свою <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-200 to-white">профессию</span></h2>
            
            <div class="flex justify-center gap-6 mb-8 text-white/80 text-xs sm:text-sm font-medium">
                <div class="flex items-center gap-2 px-3 py-1 bg-white/5 rounded-full backdrop-blur-sm border border-white/10">
                    <span class="text-accent font-bold text-lg" id="statsPrograms">0</span> Программ
                </div>
                <div class="hidden sm:flex items-center gap-2 px-3 py-1 bg-white/5 rounded-full backdrop-blur-sm border border-white/10">
                    <span class="text-blue-300 font-bold text-lg" id="statsUnis">0</span> ВУЗов
                </div>
            </div>

            <div class="relative max-w-xl mx-auto z-50">
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-2 flex gap-2 ring-4 ring-white/10 dark:ring-slate-700/50 transition-all duration-300" id="searchContainer">
                    <div class="flex-grow flex items-center px-4 bg-slate-50 dark:bg-slate-900/50 rounded-xl relative group focus-within:ring-2 focus-within:ring-rgsu-600 transition-all">
                        <i data-lucide="search" class="w-5 h-5 text-slate-400 group-focus-within:text-rgsu-600 transition-colors"></i>
                        <input type="text" id="searchInput" placeholder="Профессия, вуз или код..." class="w-full pl-3 py-3.5 outline-none bg-transparent text-sm pr-8 placeholder:text-slate-400 dark:text-white" onfocus="focusSearch()" oninput="handleSearchInput(this.value)">
                        <span class="hidden md:inline absolute right-3 text-xs text-slate-400 border border-slate-300 rounded px-1.5 py-0.5 pointer-events-none">/</span>
                        <button onclick="clearSearch()" id="clearSearchBtn" class="hidden absolute right-3 text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i data-lucide="x" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <!-- Smart Autocomplete Dropdown -->
                <div id="searchHistoryDropdown" class="absolute top-full left-2 right-2 bg-white dark:bg-slate-800 rounded-xl shadow-xl mt-2 overflow-hidden hidden z-50 border border-slate-100 dark:border-slate-700 text-left">
                    <!-- JS fills this -->
                </div>
            </div>
            
            <!-- Category Carousel -->
            <div id="popularFilters" class="flex flex-nowrap overflow-x-auto gap-3 mt-8 pb-4 px-4 justify-start md:justify-center no-scrollbar relative z-10 snap-x">
                <!-- JS injected -->
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 -mt-8 pb-20 relative z-20 flex-grow w-full">
        
        <button onclick="toggleMobileSheet()" class="md:hidden w-full bg-white dark:bg-slate-800 mb-4 py-3.5 rounded-2xl shadow-md font-bold text-rgsu-900 dark:text-white flex justify-center items-center gap-2 active:scale-95 transition-transform">
            <i data-lucide="sliders-horizontal" class="w-4 h-4"></i> Фильтры
        </button>

        <div id="filterPanel" class="hidden md:flex sticky-filters flex-col gap-4 bg-white dark:bg-slate-800/90 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-700 p-4 mb-4 backdrop-blur-md transition-all">
            
            <div class="flex flex-col xl:flex-row gap-4 justify-between items-start xl:items-center">
                <div class="flex flex-col md:flex-row gap-4 w-full xl:w-auto">
                    <div id="levelButtons" class="flex p-1.5 bg-slate-100 dark:bg-slate-900 rounded-xl w-full md:w-auto overflow-x-auto gap-1"></div>
                    
                    <div class="relative w-full md:w-48">
                        <div class="relative group">
                            <input list="regions" id="regionInput" placeholder="Регион..." onchange="updateFilters()" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-rgsu-600 dark:focus:border-blue-500 focus:ring-2 focus:ring-rgsu-600/10 dark:text-white transition pr-9">
                            <i data-lucide="map-pin" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-rgsu-600 transition-colors pointer-events-none" id="regionIcon"></i>
                            <button onclick="clearRegion()" id="clearRegionBtn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-white p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition bg-transparent"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <datalist id="regions"></datalist>
                    </div>

                    <div class="relative w-full md:w-56">
                        <div class="relative group">
                            <input list="universities" id="universityInput" placeholder="ВУЗ..." onchange="updateFilters()" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-rgsu-600 dark:focus:border-blue-500 focus:ring-2 focus:ring-rgsu-600/10 dark:text-white transition pr-9">
                            <i data-lucide="graduation-cap" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-rgsu-600 transition-colors pointer-events-none" id="uniIcon"></i>
                            <button onclick="clearUniversity()" id="clearUniBtn" class="hidden absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 hover:text-slate-600 dark:hover:text-white p-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition bg-transparent"><i data-lucide="x" class="w-3 h-3"></i></button>
                        </div>
                        <datalist id="universities"></datalist>
                    </div>

                    <div class="relative w-full md:w-40">
                        <select id="sortSelect" onchange="updateFilters()" class="w-full bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm outline-none focus:border-rgsu-600 dark:focus:border-blue-500 cursor-pointer appearance-none dark:text-white">
                            <option value="default">Сортировка</option>
                            <option value="budget_desc">Бюджет (убыв.)</option>
                            <option value="name_asc">Название (А-Я)</option>
                            <option value="region_asc">Регион (А-Я)</option>
                        </select>
                        <i data-lucide="arrow-up-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                
                <div class="flex flex-wrap items-center gap-4 w-full xl:w-auto border-t xl:border-none pt-4 xl:pt-0 dark:border-slate-700">
                    <label class="flex items-center gap-2 cursor-pointer select-none group">
                        <input type="checkbox" id="budgetToggle" class="custom-checkbox w-5 h-5 border-2 border-slate-300 dark:border-slate-600 rounded focus:ring-2 focus:ring-rgsu-600 focus:ring-offset-1 cursor-pointer appearance-none bg-white dark:bg-slate-700 transition-all" onchange="updateFilters()">
                        <span class="text-sm font-medium text-slate-600 dark:text-slate-300 group-hover:text-rgsu-900 dark:group-hover:text-white transition-colors">Бюджет</span>
                    </label>

                    <div class="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-1 hidden sm:block"></div>

                    <button onclick="toggleLayout()" id="layoutToggleBtn" class="p-2 text-slate-400 hover:text-rgsu-700 hover:bg-slate-50 dark:hover:bg-slate-700 dark:hover:text-white rounded-lg transition active:scale-95" data-tooltip="Вид: Список/Плитка">
                        <i data-lucide="layout-grid" class="w-5 h-5"></i>
                    </button>
                    
                    <button onclick="resetAllFilters()" id="globalResetBtn" class="hidden p-2 text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30 rounded-lg transition active:scale-95" title="Сбросить всё">
                        <i data-lucide="rotate-ccw" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <div id="activeFilters" class="flex flex-wrap gap-2 text-xs empty:hidden pt-2 border-t border-slate-100 dark:border-slate-700"></div>
            <div id="resultsCount" class="hidden"></div>
        </div>

        <div id="catalogGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 transition-all duration-300">
            <div class="skeleton h-80 rounded-2xl"></div><div class="skeleton h-80 rounded-2xl"></div><div class="skeleton h-80 rounded-2xl"></div>
        </div>

        <div id="sentinel" class="mt-8 h-10 w-full flex items-center justify-center">
             <svg class="animate-spin h-6 w-6 text-slate-400 hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        </div>
        
        <!-- Recently Viewed Section -->
        <div id="recentlyViewedSection" class="mt-16 mb-8 hidden">
            <h3 class="text-xl font-bold text-slate-800 dark:text-white mb-4 px-2">Вы недавно смотрели</h3>
            <div class="overflow-x-auto pb-4 -mx-4 px-4 custom-scrollbar">
                <div class="flex gap-4" id="recentlyViewedList"></div>
            </div>
        </div>
    </main>

    <button id="scrollTopBtn" onclick="scrollToTop()" class="fixed bottom-24 right-6 z-40 bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-3.5 rounded-full shadow-lg text-slate-500 dark:text-slate-400 hover:text-rgsu-700 dark:hover:text-white hover:shadow-xl transition-all hidden translate-y-10 opacity-0 duration-300 active:scale-90 md:bottom-12" title="Наверх">
        <i data-lucide="arrow-up" class="w-6 h-6"></i>
    </button>

    <div id="compareBar" class="fixed bottom-24 md:bottom-6 left-1/2 transform -translate-x-1/2 bg-rgsu-900/90 dark:bg-slate-800/90 text-white px-6 py-3 rounded-full shadow-2xl z-40 hidden flex items-center gap-4 animate-fade-in backdrop-blur-md border border-white/10 ring-1 ring-black/5 active:scale-[0.99] transition-transform">
        <span class="font-bold text-sm flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-accent animate-pulse"></div> <span id="compareCount">0</span> выбрано</span>
        <div class="h-4 w-px bg-white/20"></div>
        <button onclick="openCompareModal()" class="bg-white/20 hover:bg-white/30 px-5 py-1.5 rounded-full text-xs font-bold transition uppercase tracking-wide">Сравнить</button>
        <button onclick="clearCompare()" class="text-white/50 hover:text-white hover:bg-white/10 p-1 rounded-full transition"><i data-lucide="x" class="w-4 h-4"></i></button>
    </div>

    <div id="toastContainer" class="fixed top-24 right-6 z-50 flex flex-col gap-3 pointer-events-none"></div>

    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-200 dark:border-slate-800 z-50 flex justify-around items-center h-16 pb-safe">
        <button onclick="scrollToTop()" class="flex flex-col items-center justify-center w-full h-full text-slate-500 dark:text-slate-400 active:text-rgsu-700 dark:active:text-white space-y-1">
            <i data-lucide="search" class="w-5 h-5"></i>
            <span class="text-[10px] font-medium">Поиск</span>
        </button>
        <button onclick="toggleMobileSheet()" class="flex flex-col items-center justify-center w-full h-full text-slate-500 dark:text-slate-400 active:text-rgsu-700 dark:active:text-white space-y-1">
            <i data-lucide="sliders-horizontal" class="w-5 h-5"></i>
            <span class="text-[10px] font-medium">Фильтры</span>
        </button>
        <button onclick="toggleFavFilter()" class="flex flex-col items-center justify-center w-full h-full text-slate-500 dark:text-slate-400 active:text-rgsu-700 dark:active:text-white space-y-1 relative">
            <i data-lucide="heart" class="w-5 h-5"></i>
            <span class="text-[10px] font-medium">Избранное</span>
            <div id="mobileFavDot" class="hidden absolute top-3 right-6 w-2 h-2 bg-red-500 rounded-full"></div>
        </button>
        <button onclick="toggleTheme()" class="flex flex-col items-center justify-center w-full h-full text-slate-500 dark:text-slate-400 active:text-rgsu-700 dark:active:text-white space-y-1">
            <i data-lucide="moon" class="w-5 h-5 hidden dark:block"></i>
            <i data-lucide="sun" class="w-5 h-5 block dark:hidden"></i>
            <span class="text-[10px] font-medium">Тема</span>
        </button>
    </div>

    <div id="mobileSheet" class="fixed inset-0 z-[60] hidden">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="toggleMobileSheet()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white dark:bg-slate-900 rounded-t-3xl p-6 shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[85vh] overflow-y-auto" id="mobileSheetContent">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full mx-auto mb-8"></div>
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl text-slate-900 dark:text-white">Фильтры</h3>
                <button onclick="toggleMobileSheet()" class="p-2 bg-slate-50 dark:bg-slate-800 rounded-full text-slate-400 hover:text-slate-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="mobileFiltersContainer" class="space-y-6"></div>
            <button onclick="toggleMobileSheet()" class="w-full bg-rgsu-700 text-white font-bold py-4 rounded-xl mt-8 shadow-lg shadow-rgsu-900/20 active:scale-95 transition-transform">Применить</button>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 z-[100] hidden" role="dialog">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto p-4 flex items-center justify-center">
            <div class="relative bg-white dark:bg-slate-800 rounded-3xl shadow-2xl max-w-2xl w-full transform transition-all scale-95 opacity-0 overflow-hidden border border-slate-200 dark:border-slate-700" id="modalPanel">
                <button onclick="closeModal()" class="absolute top-4 right-4 p-2 rounded-full bg-white/80 dark:bg-slate-700/80 hover:bg-slate-100 dark:hover:bg-slate-600 z-10 transition dark:text-white no-print"><i data-lucide="x" class="w-5 h-5"></i></button>
                <div id="modalContent" class="p-8 max-h-[85vh] overflow-y-auto custom-scrollbar"></div>
            </div>
        </div>
    </div>

    <div id="compareModal" class="fixed inset-0 z-[100] hidden">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" onclick="document.getElementById('compareModal').classList.add('hidden')"></div>
        <div class="fixed inset-0 z-10 overflow-auto p-4 flex items-center justify-center">
            <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl w-full max-w-6xl p-8 overflow-hidden flex flex-col max-h-[90vh] border border-slate-200 dark:border-slate-700">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-slate-900 dark:text-white">Сравнение программ</h2>
                        <p class="text-slate-500 dark:text-slate-400 text-sm">Сравните условия и выберите лучшее</p>
                    </div>
                    <button onclick="document.getElementById('compareModal').classList.add('hidden')" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full transition dark:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 p-3 rounded-xl mb-4 text-xs text-blue-800 dark:text-blue-300 flex items-center gap-2 font-medium">
                    <i data-lucide="info" class="w-4 h-4"></i> Различия в параметрах выделены цветом
                </div>
                <div class="overflow-auto flex-grow custom-scrollbar border border-slate-100 dark:border-slate-800 rounded-xl relative">
                    <div id="compareContent" class="min-w-max"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        let allPrograms = [];
        let filteredPrograms = [];
        let visibleCount = 21;
        let showFavorites = false;
        let layoutMode = 'grid'; // 'grid' or 'list'
        let searchHistory = JSON.parse(localStorage.getItem('rgsu_search_history') || '[]');
        let recentlyViewed = JSON.parse(localStorage.getItem('rgsu_recent') || '[]');
        
        const initialState = {
            level: 'all',
            search: '',
            region: '',
            university: '',
            budget: false,
            sort: 'default'
        };
        let filters = { ...initialState };

        const favorites = JSON.parse(localStorage.getItem('rgsu_favs') || '[]');
        const compareList = new Set();

        const SHEET_ID = '12GNjcomxxU4NbXKwQ1Jq_eG7M7PLUlDlKAnBO4qwu5g';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            const savedView = localStorage.getItem('rgsu_view_mode');
            if(savedView === 'list') layoutMode = 'list';
            updateLayoutIcon();

            readURL(); 
            loadData();
            updateFavBadge(); 
            
            // Offline Detection
            window.addEventListener('offline', () => showToast('Нет подключения к интернету', 'info'));
            window.addEventListener('online', () => showToast('Подключение восстановлено'));

            document.addEventListener('mousemove', (e) => {
                const x = e.clientX / window.innerWidth;
                const y = e.clientY / window.innerHeight;
                const blob1 = document.getElementById('heroBlob1');
                const blob2 = document.getElementById('heroBlob2');
                if(blob1) blob1.style.transform = `translate(${x * 30}px, ${y * 30}px) scale(1.1)`;
                if(blob2) blob2.style.transform = `translate(-${x * 30}px, -${y * 30}px) scale(1.1)`;
            });

            // Handle browser back button
            window.addEventListener('popstate', () => {
                const hash = window.location.hash;
                if (!hash.startsWith('#program=')) {
                    document.getElementById('modal').classList.add('hidden');
                    document.body.style.overflow = '';
                } else {
                    const id = parseInt(hash.split('=')[1]);
                    if(!isNaN(id)) openModal(id, false); // Don't push state again
                }
            });

            if (window.location.hash.startsWith('#program=')) {
                const id = parseInt(window.location.hash.split('=')[1]);
                if (!isNaN(id)) setTimeout(() => openModal(id), 500);
            }

            window.addEventListener('scroll', () => {
                const btn = document.getElementById('scrollTopBtn');
                if(!btn) return;
                if (window.scrollY > 400) btn.classList.remove('hidden', 'translate-y-10', 'opacity-0');
                else btn.classList.add('translate-y-10', 'opacity-0');
            });

            const observer = new IntersectionObserver((entries) => {
                if(entries[0].isIntersecting) {
                    loadMore();
                }
            }, { rootMargin: '100px' });
            const sentinel = document.getElementById('sentinel');
            if(sentinel) observer.observe(sentinel);

            // Hotkeys
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeModal();
                    document.getElementById('compareModal').classList.add('hidden');
                    document.getElementById('shortcutsModal').classList.add('hidden');
                    blurSearch();
                }
                if (e.key === '/' && document.activeElement !== document.getElementById('searchInput')) {
                    e.preventDefault();
                    document.getElementById('searchInput').focus();
                }
                if (e.key === '?' && e.shiftKey) {
                    document.getElementById('shortcutsModal').classList.remove('hidden');
                }
                if (e.key === 'p' && e.ctrlKey) {
                    // Allow normal print if modal not open
                    if(!document.getElementById('modal').classList.contains('hidden')) {
                        e.preventDefault();
                        window.print();
                    }
                }
            });
        });

        // Live Search Input with Debounce/Delay for visual stability
        function handleSearchInput(val) {
            const btn = document.getElementById('clearSearchBtn');
            if (val) btn.classList.remove('hidden'); else btn.classList.add('hidden');
            updateFilters();
            
            // Live Suggestions
            if(val.length > 2) {
                const matches = allPrograms.filter(p => p.title.toLowerCase().includes(val.toLowerCase()) || p.inst.toLowerCase().includes(val.toLowerCase())).slice(0, 5);
                renderSuggestions(matches, val);
            } else {
                renderSearchHistory();
            }
        }

        function focusSearch() {
            document.getElementById('searchOverlay').classList.add('active');
            document.getElementById('searchContainer').classList.add('relative', 'z-50', 'scale-105');
            const val = document.getElementById('searchInput').value;
            if(val.length > 2) handleSearchInput(val);
            else renderSearchHistory();
        }

        function blurSearch() {
            document.getElementById('searchOverlay').classList.remove('active');
            document.getElementById('searchContainer').classList.remove('relative', 'z-50', 'scale-105');
            document.getElementById('searchHistoryDropdown').classList.add('hidden');
        }

        function saveSearchHistory(term) {
            if (!term || term.length < 3) return;
            if (!searchHistory.includes(term)) {
                searchHistory.unshift(term);
                if (searchHistory.length > 5) searchHistory.pop();
                localStorage.setItem('rgsu_search_history', JSON.stringify(searchHistory));
            }
        }

        function renderSearchHistory() {
            const list = document.getElementById('historyList');
            const dropdown = document.getElementById('searchHistoryDropdown');
            if (searchHistory.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            // Add Header
            dropdown.innerHTML = `<div class="px-4 py-2 text-xs text-slate-400 font-bold uppercase tracking-wider bg-slate-50 dark:bg-slate-900/50">История поиска</div><div id="historyListContent"></div>`;
            
            document.getElementById('historyListContent').innerHTML = searchHistory.map(term => `
                <div class="px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-3 text-sm text-slate-700 dark:text-slate-300 transition" onclick="setSearchFromHistory('${term}')">
                    <i data-lucide="clock" class="w-4 h-4 text-slate-400"></i> ${term}
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
            lucide.createIcons();
        }

        function renderSuggestions(matches, query) {
            const dropdown = document.getElementById('searchHistoryDropdown');
            if(matches.length === 0) {
                dropdown.classList.add('hidden');
                return;
            }
            dropdown.innerHTML = `<div class="px-4 py-2 text-xs text-slate-400 font-bold uppercase tracking-wider bg-slate-50 dark:bg-slate-900/50">Результаты</div><div id="suggestionsContent"></div>`;
            
            document.getElementById('suggestionsContent').innerHTML = matches.map(p => `
                <div class="px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer flex items-center gap-3 text-sm text-slate-700 dark:text-slate-300 transition" onclick="openModal(${p.id})">
                    <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
                    <div>
                        <div class="font-bold">${highlight(p.title, query)}</div>
                        <div class="text-xs text-slate-500">${p.inst}</div>
                    </div>
                </div>
            `).join('');
            dropdown.classList.remove('hidden');
            lucide.createIcons();
        }

        function setSearchFromHistory(term) {
            const input = document.getElementById('searchInput');
            input.value = term;
            document.getElementById('clearSearchBtn').classList.remove('hidden');
            updateFilters();
            blurSearch(); 
        }

        function addToRecent(id) {
            recentlyViewed = recentlyViewed.filter(x => x !== id);
            recentlyViewed.unshift(id);
            if(recentlyViewed.length > 8) recentlyViewed.pop();
            localStorage.setItem('rgsu_recent', JSON.stringify(recentlyViewed));
            renderRecentlyViewed();
        }

        function renderRecentlyViewed() {
            const container = document.getElementById('recentlyViewedSection');
            const list = document.getElementById('recentlyViewedList');
            
            if (recentlyViewed.length === 0) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            const items = recentlyViewed.map(id => allPrograms.find(p => p.id === id)).filter(p => p);
            
            list.innerHTML = items.map(p => `
                <div class="min-w-[200px] bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-100 dark:border-slate-700 cursor-pointer hover:shadow-md transition" onclick="openModal(${p.id})">
                    <div class="text-[10px] text-slate-400 uppercase font-bold mb-1 truncate">${p.level === 'VO' ? 'ВУЗ' : 'СПО'}</div>
                    <div class="font-bold text-slate-800 dark:text-slate-200 text-sm line-clamp-2 leading-tight mb-2">${p.title}</div>
                    <div class="text-xs text-slate-500 dark:text-slate-400 truncate">${p.inst}</div>
                </div>
            `).join('');
        }

        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) window.requestAnimationFrame(step);
            };
            window.requestAnimationFrame(step);
        }

        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }

        async function loadData() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('Network error');
                const text = await response.text();
                const results = Papa.parse(text, { header: true, skipEmptyLines: true });
                
                allPrograms = results.data.map((row, i) => {
                    const budget = row['budget_seats'] || "";
                    const hasBudget = budget.toLowerCase().includes('есть') || budget.toLowerCase().includes('мест');
                    const macro = row['macrogroup_name'] || "Общее";
                    
                    const budgetMatch = budget.match(/\d+/);
                    const rawBudget = budgetMatch ? parseInt(budgetMatch[0]) : (hasBudget ? 1 : 0);
                    
                    const isNew2025 = budget.includes('2025') || row['program_name'].includes('2025');

                    return {
                        id: i,
                        title: row['program_name'] || "Без названия",
                        code: (row['fgos_code'] || "").replace(/^\d{4}-\d{2}-\d{2}$/, "Код"), 
                        inst: row['institution_name'] || "ВУЗ не указан",
                        region: row['region'] || "РФ",
                        level: (row['education_level'] || "").toUpperCase().includes('СПО') ? 'SPO' : 'VO',
                        cat: macro,
                        hasBudget: hasBudget,
                        places: budget,
                        url: row['url'] || "#",
                        desc: `${row['program_name']}. ${macro}.`,
                        color: getCatColor(macro),
                        icon: getCatIcon(macro),
                        rawBudget: rawBudget,
                        isNew: isNew2025
                    };
                });
                
                const totalPrograms = allPrograms.length;
                const totalUnis = new Set(allPrograms.map(p => p.inst)).size;
                animateValue(document.getElementById("statsPrograms"), 0, totalPrograms, 1500);
                animateValue(document.getElementById("statsUnis"), 0, totalUnis, 1500);

                initUI();
                applyFilters();
                renderRecentlyViewed();
            } catch (e) {
                console.error(e);
                const grid = document.getElementById('catalogGrid');
                if(grid) grid.innerHTML = `<div class="col-span-3 text-center py-20 text-red-500 font-bold dark:text-red-400">Ошибка загрузки данных.</div>`;
            }
        }

        function initUI() {
            const levels = [...new Set(allPrograms.map(p => p.level))].sort();
            const levelContainer = document.getElementById('levelButtons');
            if (levelContainer) {
                let levelHTML = `<button onclick="setFilter('level', 'all')" id="lvl-all" class="px-5 py-2.5 rounded-xl text-sm font-bold transition whitespace-nowrap active:scale-95">Все</button>`;
                levels.forEach(l => {
                    const label = l === 'SPO' ? 'Колледж' : 'ВУЗ';
                    levelHTML += `<button onclick="setFilter('level', '${l}')" id="lvl-${l}" class="px-5 py-2.5 rounded-xl text-sm font-bold transition whitespace-nowrap active:scale-95">${label}</button>`;
                });
                levelContainer.innerHTML = levelHTML;
            }

            const regions = [...new Set(allPrograms.map(p => p.region).filter(r => r && r !== "РФ"))].sort();
            const dl = document.getElementById('regions');
            if(dl) regions.forEach(r => dl.appendChild(new Option(r)));

            const universities = [...new Set(allPrograms.map(p => p.inst).filter(i => i && i !== "ВУЗ не указан"))].sort();
            const uniDl = document.getElementById('universities');
            if(uniDl) universities.forEach(u => uniDl.appendChild(new Option(u)));

            const cats = allPrograms.map(p => p.cat);
            const counts = {};
            cats.forEach(x => { counts[x] = (counts[x] || 0) + 1; });
            const topCats = Object.keys(counts).sort((a,b) => counts[b] - counts[a]).slice(0, 5);
            
            const popDiv = document.getElementById('popularFilters');
            if(popDiv) {
                popDiv.innerHTML = topCats.map(c => 
                    `<div onclick="document.getElementById('searchInput').value='${c}'; updateFilters()" class="flex-shrink-0 w-32 bg-white dark:bg-slate-800 rounded-xl p-3 cursor-pointer hover:shadow-lg transition border border-slate-100 dark:border-slate-700 flex flex-col items-center text-center gap-2 snap-center group">
                        <div class="w-10 h-10 rounded-full bg-rgsu-50 dark:bg-slate-700 text-rgsu-600 dark:text-blue-300 flex items-center justify-center group-hover:scale-110 transition"><i data-lucide="${getCatIcon(c)}" class="w-5 h-5"></i></div>
                        <span class="text-xs font-bold text-slate-700 dark:text-slate-200 line-clamp-2">${c}</span>
                    </div>`
                ).join('');
            }

            const searchInput = document.getElementById('searchInput');
            if(searchInput) searchInput.value = filters.search;
            const regionInput = document.getElementById('regionInput');
            if(regionInput) regionInput.value = filters.region;
            const universityInput = document.getElementById('universityInput');
            if(universityInput) universityInput.value = filters.university;
            const budgetToggle = document.getElementById('budgetToggle');
            if(budgetToggle) budgetToggle.checked = filters.budget;
            const sortSelect = document.getElementById('sortSelect');
            if(sortSelect) sortSelect.value = filters.sort;
            
            if(filters.search) document.getElementById('clearSearchBtn')?.classList.remove('hidden');
            if(filters.region) {
                document.getElementById('clearRegionBtn')?.classList.remove('hidden');
                document.getElementById('regionIcon')?.classList.add('hidden');
            }
            if(filters.university) {
                document.getElementById('clearUniBtn')?.classList.remove('hidden');
                document.getElementById('uniIcon')?.classList.add('hidden');
            }
        }

        function updateURL() {
            const params = new URLSearchParams();
            if(filters.level !== 'all') params.set('level', filters.level);
            if(filters.search) params.set('q', filters.search);
            if(filters.region) params.set('region', filters.region);
            if(filters.university) params.set('uni', filters.university);
            if(filters.budget) params.set('budget', '1');
            if(filters.sort !== 'default') params.set('sort', filters.sort);
            
            const newUrl = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}${window.location.hash}`;
            try { window.history.replaceState({}, '', newUrl); } catch (e) { console.warn('URL update blocked:', e); }
        }

        function readURL() {
            const params = new URLSearchParams(window.location.search);
            if(params.has('level')) filters.level = params.get('level');
            if(params.has('q')) filters.search = params.get('q');
            if(params.has('region')) filters.region = params.get('region');
            if(params.has('uni')) filters.university = params.get('uni');
            if(params.has('budget')) filters.budget = true;
            if(params.has('sort')) filters.sort = params.get('sort');
        }

        function setFilter(key, value) {
            filters[key] = value;
            updateFilters();
        }

        function resetAllFilters() {
            filters = { ...initialState };
            
            document.getElementById('searchInput').value = '';
            document.getElementById('regionInput').value = '';
            document.getElementById('universityInput').value = '';
            document.getElementById('budgetToggle').checked = false;
            document.getElementById('sortSelect').value = 'default';
            
            updateFilters();
        }

        function updateFilters() {
            const searchInput = document.getElementById('searchInput');
            if(searchInput) filters.search = searchInput.value.toLowerCase();
            const regionInput = document.getElementById('regionInput');
            if(regionInput) filters.region = regionInput.value;
            const universityInput = document.getElementById('universityInput');
            if(universityInput) filters.university = universityInput.value;
            const budgetToggle = document.getElementById('budgetToggle');
            if(budgetToggle) filters.budget = budgetToggle.checked;
            const sortSelect = document.getElementById('sortSelect');
            if(sortSelect) filters.sort = sortSelect.value;
            
            const regionBtn = document.getElementById('clearRegionBtn');
            const regionIcon = document.getElementById('regionIcon');
            if (filters.region) { regionBtn?.classList.remove('hidden'); regionIcon?.classList.add('hidden'); } 
            else { regionBtn?.classList.add('hidden'); regionIcon?.classList.remove('hidden'); }

            const uniBtn = document.getElementById('clearUniBtn');
            const uniIcon = document.getElementById('uniIcon');
            if (filters.university) { uniBtn?.classList.remove('hidden'); uniIcon?.classList.add('hidden'); }
            else { uniBtn?.classList.add('hidden'); uniIcon?.classList.remove('hidden'); }

            // Show Global Reset if any filter active
            const resetBtn = document.getElementById('globalResetBtn');
            const isDefault = !filters.search && !filters.region && !filters.university && !filters.budget && filters.level === 'all';
            if (resetBtn) {
                if(!isDefault) resetBtn.classList.remove('hidden');
                else resetBtn.classList.add('hidden');
            }

            updateURL();
            applyFilters(true);
        }

        function applyFilters(resetCount = false) {
            if (resetCount) visibleCount = 21;

            filteredPrograms = allPrograms.filter(p => {
                if (showFavorites && !favorites.includes(p.id)) return false;
                
                const matchSearch = p.title.toLowerCase().includes(filters.search) || p.cat.toLowerCase().includes(filters.search) || p.inst.toLowerCase().includes(filters.search);
                const matchLvl = filters.level === 'all' || p.level === filters.level;
                const matchReg = !filters.region || p.region === filters.region;
                const matchUni = !filters.university || p.inst === filters.university;
                const matchBudg = !filters.budget || p.hasBudget;
                
                return matchSearch && matchLvl && matchReg && matchUni && matchBudg;
            });

            if (filters.sort === 'budget_desc') filteredPrograms.sort((a, b) => b.rawBudget - a.rawBudget);
            else if (filters.sort === 'name_asc') filteredPrograms.sort((a, b) => a.title.localeCompare(b.title));
            else if (filters.sort === 'region_asc') filteredPrograms.sort((a, b) => a.region.localeCompare(b.region));

            renderUI();
        }

        function renderUI() {
            document.querySelectorAll('#levelButtons button').forEach(b => {
                const isActive = b.id === `lvl-${filters.level}`;
                b.className = isActive ? 
                    "px-5 py-2.5 rounded-xl text-sm font-bold transition bg-rgsu-900 text-white shadow-lg shadow-rgsu-900/20 whitespace-nowrap ring-2 ring-transparent focus:ring-rgsu-600 focus:ring-offset-2 dark:bg-blue-600 dark:shadow-none active:scale-95" : 
                    "px-5 py-2.5 rounded-xl text-sm font-bold transition text-slate-500 bg-white border border-slate-200 hover:bg-slate-50 hover:text-rgsu-900 whitespace-nowrap focus:ring-2 focus:ring-rgsu-600 focus:ring-offset-2 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400 dark:hover:text-white active:scale-95";
            });

            const chipsDiv = document.getElementById('activeFilters');
            if(chipsDiv) {
                let chipsHTML = '';
                if (filters.region) chipsHTML += createChip(filters.region, () => { document.getElementById('regionInput').value=''; updateFilters(); });
                if (filters.university) chipsHTML += createChip(filters.university, () => { document.getElementById('universityInput').value=''; updateFilters(); });
                if (filters.budget) chipsHTML += createChip('Бюджет', () => { document.getElementById('budgetToggle').checked=false; updateFilters(); });
                if (filters.search) chipsHTML += createChip(`Поиск: ${filters.search}`, () => { clearSearch(); });
                chipsDiv.innerHTML = chipsHTML;
            }

            const resultsCountEl = document.getElementById('resultsCount');
            if(resultsCountEl) resultsCountEl.innerText = `Найдено: ${filteredPrograms.length}`;

            const grid = document.getElementById('catalogGrid');
            const spinner = document.getElementById('loadingSpinner');
            
            if(!grid) return;

            // Apply Layout Class
            if(layoutMode === 'list') grid.classList.add('layout-list');
            else grid.classList.remove('layout-list');

            const q = filters.search.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            
            if (filteredPrograms.length === 0) {
                if(showFavorites) {
                    grid.innerHTML = `
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-20 flex flex-col items-center animate-fade-in">
                        <div class="w-32 h-32 bg-red-50 dark:bg-red-900/20 rounded-full flex items-center justify-center mb-6 shadow-inner">
                            <svg class="w-16 h-16 text-red-300 dark:text-red-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">В избранном пусто</h3>
                        <p class="text-slate-500 dark:text-slate-400 mb-8 max-w-sm">Добавляйте понравившиеся программы, нажимая на сердечко, чтобы сравнить их позже.</p>
                        <button onclick="toggleFavFilter()" class="px-6 py-3 bg-red-500 text-white rounded-xl font-bold shadow-lg hover:bg-red-600 transition active:scale-95">Вернуться к поиску</button>
                    </div>
                    `;
                } else {
                    grid.innerHTML = `
                    <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-20 flex flex-col items-center animate-fade-in">
                        <div class="w-32 h-32 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center mb-6 shadow-inner">
                            <svg class="w-16 h-16 text-slate-300 dark:text-slate-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="9" y1="14" x2="15" y2="14"></line></svg>
                        </div>
                        <h3 class="text-2xl font-bold text-slate-800 dark:text-white mb-2">Пусто...</h3>
                        <p class="text-slate-500 dark:text-slate-400 mb-8 max-w-sm">По вашему запросу ничего не найдено. Попробуйте изменить фильтры или регион.</p>
                        <button onclick="resetAllFilters()" class="px-6 py-3 bg-rgsu-900 text-white rounded-xl font-bold shadow-lg hover:bg-rgsu-800 transition active:scale-95">Сбросить все фильтры</button>
                    </div>
                    `;
                }
                if(spinner) spinner.classList.add('hidden');
                lucide.createIcons();
                return;
            }

            const dataToShow = filteredPrograms.slice(0, visibleCount);
            let lastGroup = '';
            let gridHTML = '';
            
            dataToShow.forEach((p, index) => {
                if (filters.sort === 'region_asc') {
                    if (p.region !== lastGroup) {
                        gridHTML += `<div class="col-span-1 md:col-span-2 lg:col-span-3 pt-4 pb-2 animate-fade-in"><h3 class="text-lg font-bold text-slate-400 dark:text-slate-500 uppercase tracking-wider border-b border-slate-200 dark:border-slate-700 pb-1">${p.region}</h3></div>`;
                        lastGroup = p.region;
                    }
                }

                const isFav = favorites.includes(p.id);
                const isCompared = compareList.has(p.id);
                const isViewed = recentlyViewed.includes(p.id);
                const paddingClass = layoutMode === 'list' ? 'p-6' : 'p-6';
                const delay = Math.min(index * 50, 500); 
                
                const avatar = p.icon ? `<i data-lucide="${p.icon}" class="w-5 h-5"></i>` : `<span class="text-lg font-bold">${p.title[0]}</span>`;

                // Layout-specific classes
                const wrapperClass = layoutMode === 'list' ? 'flex-row items-center gap-6' : 'flex-col';
                
                gridHTML += `
                <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-sm hover:shadow-xl card-hover border border-slate-100 dark:border-slate-700 flex ${wrapperClass} ${paddingClass} animate-fade-in relative transition-all duration-300 ${p.color} ${isViewed ? 'opacity-90' : ''}" style="animation-delay: ${delay}ms; opacity: 0;">
                    
                    <div class="${layoutMode === 'list' ? 'w-full md:w-auto flex-grow' : 'w-full'} flex-grow cursor-pointer group" onclick="openModal(${p.id})">
                        <div class="flex justify-between items-start mb-2">
                             <div class="flex items-start gap-3">
                                <div class="w-10 h-10 rounded-full bg-slate-50 dark:bg-slate-700 flex items-center justify-center text-slate-400 dark:text-slate-300 shrink-0 group-hover:bg-rgsu-50 dark:group-hover:bg-blue-900/30 group-hover:text-rgsu-600 dark:group-hover:text-blue-400 transition-colors duration-300 card-img relative">
                                    ${avatar}
                                    ${isViewed ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-slate-200 dark:bg-slate-600 rounded-full border-2 border-white dark:border-slate-800 flex items-center justify-center"><div class="w-1 h-1 bg-slate-500 rounded-full"></div></div>' : ''}
                                </div>
                                <div>
                                    <div class="flex flex-wrap gap-2 mb-1">
                                        <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide border ${p.level === 'VO' ? 'bg-indigo-50 text-indigo-700 border-indigo-100 dark:bg-indigo-900/30 dark:text-indigo-300 dark:border-indigo-800' : 'bg-emerald-50 text-emerald-700 border-emerald-100 dark:bg-emerald-900/30 dark:text-emerald-300 dark:border-emerald-800'}">${p.level === 'VO' ? 'ВУЗ' : 'Колледж'}</span>
                                        ${p.hasBudget ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-green-50 text-green-700 border border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800 flex items-center gap-1 relative overflow-hidden"><div class="absolute inset-0 shimmer-bg"></div><i data-lucide="check-circle-2" class="w-3 h-3 relative z-10"></i> <span class="relative z-10">Бюджет</span></span>` : ''}
                                        ${p.isNew ? `<span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide bg-purple-50 text-purple-700 border border-purple-200 dark:bg-purple-900/30 dark:text-purple-300 dark:border-purple-800 relative overflow-hidden"><div class="absolute inset-0 shimmer-bg"></div><span class="relative z-10">New 2025</span></span>` : ''}
                                    </div>
                                    <h3 class="font-bold text-slate-900 dark:text-white text-lg leading-snug group-hover:text-rgsu-700 dark:group-hover:text-blue-400 transition duration-300">${highlight(p.title, q)}</h3>
                                </div>
                             </div>
                        </div>
                        
                        <div class="space-y-1 ml-13 pl-13 md:ml-0 md:pl-0 mt-2">
                            <p class="text-sm text-slate-700 dark:text-slate-300 font-semibold flex items-start gap-2 group/tag" onclick="event.stopPropagation(); document.getElementById('universityInput').value='${p.inst}'; updateFilters();"><i data-lucide="building-2" class="w-4 h-4 text-slate-400 mt-0.5 shrink-0"></i> <span class="hover:text-rgsu-600 hover:underline transition">${highlight(p.inst, q)}</span></p>
                            <p class="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2 group/tag" onclick="event.stopPropagation(); document.getElementById('regionInput').value='${p.region}'; updateFilters();"><i data-lucide="map-pin" class="w-4 h-4 text-slate-400 shrink-0"></i> <span class="hover:text-rgsu-600 hover:underline transition">${p.region}</span></p>
                        </div>
                    </div>

                    <div class="${layoutMode === 'list' ? 'flex-col border-l border-slate-100 pl-4 ml-4 hidden md:flex min-w-[140px]' : 'mt-6 pt-4 border-t border-slate-50 dark:border-slate-700 flex items-center justify-between'}">
                        <div class="flex gap-2 ${layoutMode === 'list' ? 'flex-col w-full' : ''}">
                            <button onclick="toggleFav(${p.id}, this)" class="text-slate-300 dark:text-slate-600 hover:text-red-500 dark:hover:text-red-500 transition hover:scale-110 p-1 fav-btn-target active:scale-90 flex items-center gap-2" data-tooltip="В избранное">
                                <i data-lucide="heart" class="w-5 h-5 ${isFav ? 'fill-red-500 text-red-500' : ''}"></i> ${layoutMode === 'list' ? '<span class="text-xs font-bold text-slate-500">В избранное</span>' : ''}
                            </button>
                            <label class="flex items-center gap-2 cursor-pointer text-xs font-bold text-slate-400 hover:text-rgsu-700 dark:hover:text-blue-400 select-none transition-colors">
                                <input type="checkbox" class="rounded border-slate-300 dark:border-slate-600 text-rgsu-700 focus:ring-rgsu-600 w-4 h-4 dark:bg-slate-700" ${isCompared ? 'checked' : ''} onchange="toggleCompare(${p.id})">
                                СРАВНИТЬ
                            </label>
                        </div>
                        ${layoutMode !== 'list' ? `<button onclick="openModal(${p.id})" class="text-rgsu-600 dark:text-blue-400 hover:text-rgsu-800 dark:hover:text-blue-300 text-sm font-bold flex items-center gap-1 group/btn active:scale-95 transition">Подробнее <i data-lucide="chevron-right" class="w-4 h-4 group-hover/btn:translate-x-1 transition-transform"></i></button>` : ''}
                    </div>
                </div>
            `;
            });

            grid.innerHTML = gridHTML;

            if(spinner) {
                if (visibleCount >= filteredPrograms.length) {
                    spinner.classList.add('hidden');
                } else {
                    spinner.classList.remove('hidden');
                }
            }
            
            lucide.createIcons();
        }

        function createChip(label, onClick) {
            return `<button class="bg-rgsu-50 dark:bg-blue-900/30 text-rgsu-700 dark:text-blue-300 px-3 py-1 rounded-lg flex items-center gap-2 hover:bg-rgsu-100 dark:hover:bg-blue-900/50 transition font-medium animate-fade-in active:scale-95" onclick="(${onClick})()">
                ${label} <i data-lucide="x" class="w-3 h-3"></i>
            </button>`;
        }

        function loadMore() {
            if (visibleCount >= filteredPrograms.length) return;
            visibleCount += 21;
            renderUI();
        }

        // === ACTIONS ===
        function updateFavBadge() {
            const badge = document.getElementById('favCountBadge');
            const mobileDot = document.getElementById('mobileFavDot');
            const exportBtn = document.getElementById('exportFavBtn');
            if (favorites.length > 0) {
                badge.innerText = favorites.length;
                badge.classList.remove('hidden');
                mobileDot.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
                mobileDot.classList.add('hidden');
            }
            
            if(showFavorites && favorites.length > 0) exportBtn.classList.remove('hidden');
            else exportBtn.classList.add('hidden');
        }

        function toggleFav(id, btn) {
            const index = favorites.indexOf(id);
            if (index === -1) {
                favorites.push(id);
                // Confetti only if adding
                const rect = btn.getBoundingClientRect();
                createConfetti(rect.left + rect.width/2, rect.top + rect.height/2);
                showToast('Добавлено в избранное');
                flyToFav(btn);
            } else {
                favorites.splice(index, 1);
                showToast('Удалено из избранного', 'info', true, () => {
                    toggleFav(id, btn);
                });
            }
            localStorage.setItem('rgsu_favs', JSON.stringify(favorites));
            updateFavBadge();
            
            if (showFavorites) { applyFilters(); } 
            else {
                const icon = btn.querySelector('svg');
                if (favorites.includes(id)) icon.classList.add('fill-red-500', 'text-red-500');
                else icon.classList.remove('fill-red-500', 'text-red-500');
            }
        }

        // Animation: Fly Heart
        function flyToFav(startBtn) {
            const heart = startBtn.querySelector('svg').cloneNode(true);
            const startRect = startBtn.getBoundingClientRect();
            const target = document.getElementById('navHeartIcon');
            if(!target) return;
            const targetRect = target.getBoundingClientRect();
            
            heart.style.position = 'fixed';
            heart.style.left = `${startRect.left}px`;
            heart.style.top = `${startRect.top}px`;
            heart.style.width = '20px';
            heart.style.height = '20px';
            heart.style.zIndex = '100';
            heart.style.pointerEvents = 'none';
            heart.classList.add('text-red-500', 'fill-red-500');
            
            const tx = targetRect.left - startRect.left;
            const ty = targetRect.top - startRect.top;
            
            heart.style.setProperty('--tx', `${tx}px`);
            heart.style.setProperty('--ty', `${ty}px`);
            heart.style.animation = 'flyToCart 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards';
            
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 800);
        }
        
        function createConfetti(x, y) {
            for(let i=0; i<10; i++) {
                const part = document.createElement('div');
                part.className = 'fixed w-2 h-2 rounded-full z-[100] pointer-events-none';
                part.style.backgroundColor = ['#EF4444', '#3B82F6', '#F59E0B', '#10B981'][Math.floor(Math.random()*4)];
                part.style.left = x + 'px';
                part.style.top = y + 'px';
                
                const angle = Math.random() * Math.PI * 2;
                const dist = 30 + Math.random() * 50;
                const tx = Math.cos(angle) * dist + 'px';
                const ty = Math.sin(angle) * dist + 'px';
                
                part.style.setProperty('--x', tx);
                part.style.setProperty('--y', ty);
                part.style.animation = 'confetti 0.6s ease-out forwards';
                
                document.body.appendChild(part);
                setTimeout(() => part.remove(), 600);
            }
        }

        function toggleCompare(id) {
            if (compareList.has(id)) {
                compareList.delete(id);
                showToast('Убрано из сравнения', 'info');
            } else {
                if(compareList.size >= 4) {
                    showToast('Максимум 4 программы', 'info');
                    setTimeout(renderUI, 50);
                    return;
                }
                compareList.add(id);
                showToast('Добавлено к сравнению');
            }
            const bar = document.getElementById('compareBar');
            if (compareList.size > 0) {
                bar.classList.remove('hidden');
                bar.classList.add('flex');
                document.getElementById('compareCount').innerText = compareList.size;
            } else {
                bar.classList.add('hidden');
                bar.classList.remove('flex');
            }
        }

        function clearCompare() {
            compareList.clear();
            toggleCompare(0); 
            renderUI();
        }
        
        function clearUniversity() {
            document.getElementById('universityInput').value = '';
            updateFilters();
        }
        
        function exportFavorites() {
            // Placeholder text copy
            const items = allPrograms.filter(p => favorites.includes(p.id));
            if(items.length === 0) return;
            
            const text = items.map(p => `- ${p.title} (${p.level}) в ${p.inst}. ${p.region}.`).join('\n');
            navigator.clipboard.writeText(text).then(() => showToast('Список скопирован!'));
        }
        
        function exportFavoritesCSV() {
            const items = allPrograms.filter(p => favorites.includes(p.id));
            if(items.length === 0) return;
            
            // Generate CSV
            const headers = ["Название", "ВУЗ", "Регион", "Уровень", "Бюджет", "Ссылка"];
            const rows = items.map(p => [
                `"${p.title.replace(/"/g, '""')}"`,
                `"${p.inst.replace(/"/g, '""')}"`,
                `"${p.region}"`,
                p.level === 'VO' ? 'ВУЗ' : 'СПО',
                `"${p.places}"`,
                p.url
            ]);
            
            const csvContent = "\uFEFF" + [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "rgsu_favorites.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('Файл скачан');
        }

        function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function clearSearch() { 
            const el = document.getElementById('searchInput'); 
            if(el) el.value = ''; 
            blurSearch();
            updateFilters(); 
        }
        function clearRegion() { 
            const el = document.getElementById('regionInput'); 
            if(el) el.value = ''; 
            updateFilters(); 
        }
        
        function showToast(message, type = 'success', hasUndo = false, undoCallback = null) {
            const container = document.getElementById('toastContainer');
            if(!container) return;
            const toast = document.createElement('div');
            const icon = type === 'success' ? 'check-circle' : 'info';
            const color = type === 'success' ? 'bg-emerald-600' : 'bg-slate-800 dark:bg-slate-700';
            
            toast.className = `${color} text-white px-5 py-4 rounded-xl shadow-xl flex items-center gap-3 animate-toast pointer-events-auto min-w-[240px] border border-white/10 backdrop-blur-md justify-between`;
            
            let html = `<div class="flex items-center gap-2"><i data-lucide="${icon}" class="w-5 h-5"></i> <span class="text-sm font-bold tracking-wide">${message}</span></div>`;
            
            if(hasUndo) {
                html += `<button id="undoBtn" class="text-xs uppercase font-bold underline opacity-80 hover:opacity-100">Отмена</button>`;
            }
            
            toast.innerHTML = html;
            container.appendChild(toast);
            lucide.createIcons();
            
            if(hasUndo && undoCallback) {
                toast.querySelector('#undoBtn').onclick = () => {
                    undoCallback();
                    toast.remove();
                };
            }

            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function highlight(text, query) {
            if (!query) return text;
            const regex = new RegExp(`(${query})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-500/50 dark:text-white text-slate-900 rounded-sm px-0.5">$1</mark>');
        }

        function toggleCompactMode(render = true) {
            if (render) toggleLayout(); // Redirect legacy call
        }
        
        function toggleLayout() {
            layoutMode = layoutMode === 'grid' ? 'list' : 'grid';
            localStorage.setItem('rgsu_view_mode', layoutMode);
            updateLayoutIcon();
            renderUI();
        }
        
        function updateLayoutIcon() {
            const btn = document.getElementById('layoutToggleBtn');
            if(!btn) return;
            const icon = layoutMode === 'grid' ? 'layout-grid' : 'list';
            btn.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5"></i>`;
            
            if(layoutMode === 'list') {
                btn.classList.add('bg-slate-100', 'text-rgsu-900', 'dark:bg-slate-700', 'dark:text-white');
                btn.classList.remove('text-slate-400');
            } else {
                btn.classList.remove('bg-slate-100', 'text-rgsu-900', 'dark:bg-slate-700', 'dark:text-white');
                btn.classList.add('text-slate-400');
            }
            lucide.createIcons();
        }

        function getCatColor(cat) {
            const c = cat.toLowerCase();
            if (c.includes('it')) return 'border-l-4 border-l-blue-500 dark:border-l-blue-400';
            if (c.includes('педагог')) return 'border-l-4 border-l-orange-400';
            if (c.includes('медиц')) return 'border-l-4 border-l-red-400';
            if (c.includes('инжен')) return 'border-l-4 border-l-slate-500 dark:border-l-slate-400';
            return 'border-l-4 border-l-indigo-200 dark:border-l-indigo-700';
        }
        function getCatIcon(cat) {
            const c = cat.toLowerCase();
            if (c.includes('it')) return 'monitor';
            if (c.includes('педагог')) return 'book-open';
            if (c.includes('медиц')) return 'activity';
            return 'graduation-cap';
        }

        // === MODALS ===
        function openModal(id, pushHistory = true) {
            const p = allPrograms.find(x => x.id === id);
            if (!p) return;
            
            if(pushHistory) {
                try { 
                    history.pushState({modalId: id}, '', `#program=${id}`);
                    document.title = `${p.title} - РГСУ Портал`;
                } catch (e) {}
            }
            
            addToRecent(id);
            const isFav = favorites.includes(p.id);
            
            // Similar Programs
            const similar = allPrograms
                .filter(x => x.cat === p.cat && x.level === p.level && x.id !== p.id)
                .slice(0, 3);
            
            let similarHTML = '';
            if(similar.length > 0) {
                similarHTML = `
                    <div class="mt-8 pt-6 border-t border-slate-100 dark:border-slate-700 no-print">
                        <h4 class="font-bold text-slate-800 dark:text-white mb-4">Похожие программы</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            ${similar.map(s => `
                                <div class="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl border border-slate-100 dark:border-slate-600 cursor-pointer hover:shadow-md transition" onclick="openModal(${s.id})">
                                    <div class="text-[10px] text-slate-400 uppercase font-bold mb-1 truncate">${s.inst}</div>
                                    <div class="font-bold text-sm text-slate-800 dark:text-white line-clamp-2 leading-tight">${s.title}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            document.getElementById('modalContent').innerHTML = `
                <div class="flex justify-between items-start mb-8">
                    <div class="flex items-start gap-5">
                        <div class="w-16 h-16 bg-gradient-to-br from-rgsu-50 to-white dark:from-slate-700 dark:to-slate-800 border border-rgsu-100 dark:border-slate-600 rounded-2xl flex items-center justify-center text-rgsu-700 dark:text-blue-300 shrink-0 shadow-lg shadow-rgsu-900/5 no-print">
                            <i data-lucide="${p.icon}" class="w-8 h-8"></i>
                        </div>
                        <div>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <span class="px-2.5 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 flex items-center gap-1">
                                    <i data-lucide="graduation-cap" class="w-3 h-3"></i> ${p.level === 'VO' ? 'Высшее' : 'СПО'}
                                </span>
                                <span class="px-2.5 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300 font-mono flex items-center gap-1">
                                    <i data-lucide="hash" class="w-3 h-3"></i> ${p.code}
                                </span>
                            </div>
                            <h2 class="text-2xl sm:text-3xl font-extrabold leading-tight text-slate-900 dark:text-white mb-2">${p.title}</h2>
                            <p class="text-rgsu-700 dark:text-blue-400 font-bold text-lg flex items-center gap-2"><i data-lucide="building-2" class="w-5 h-5"></i> ${p.inst}</p>
                        </div>
                    </div>
                    <button class="no-print p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-400" onclick="generateQR('${window.location.href}')" data-tooltip="QR-код"><i data-lucide="qr-code" class="w-5 h-5"></i></button>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <div class="bg-blue-50/50 dark:bg-slate-900 p-5 rounded-2xl border border-blue-100 dark:border-slate-600">
                        <div class="text-xs text-blue-400 uppercase font-bold mb-2 tracking-wider">Места и Бюджет</div>
                        <div class="font-bold text-slate-800 dark:text-white text-xl">${p.places}</div>
                        ${p.hasBudget ? '<div class="mt-3 inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 font-bold text-sm"><i data-lucide="check-circle-2" class="w-4 h-4"></i> Бюджет</div>' : ''}
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-900 p-5 rounded-2xl border border-slate-100 dark:border-slate-600">
                        <div class="text-xs text-slate-400 uppercase font-bold mb-2 tracking-wider">Локация</div>
                        <div class="font-bold text-slate-800 dark:text-white text-xl flex items-center gap-2"><i data-lucide="map-pin" class="w-5 h-5 text-slate-400"></i> ${p.region}</div>
                    </div>
                </div>
                <div class="prose prose-sm text-slate-600 dark:text-slate-300 mb-8 bg-white dark:bg-transparent p-2">
                    <h4 class="font-bold text-slate-900 dark:text-white mb-3 text-lg">О программе</h4>
                    <p class="leading-relaxed text-base">${p.desc}</p>
                </div>
                
                <div id="qrCodeContainer" class="hidden flex justify-center mb-6 no-print">
                    <!-- QR will be injected here -->
                </div>

                ${similarHTML}

                <div class="flex gap-3 sticky bottom-0 bg-white/95 dark:bg-slate-800/95 backdrop-blur-sm pt-4 pb-2 border-t border-slate-100 dark:border-slate-700 items-center -mx-4 px-4 sm:mx-0 sm:px-0 no-print">
                    <a href="${p.url}" target="_blank" class="flex-grow text-center bg-rgsu-700 hover:bg-rgsu-800 dark:bg-blue-600 dark:hover:bg-blue-700 text-white py-4 rounded-xl font-bold transition shadow-lg flex justify-center items-center gap-2 active:scale-[0.98]">
                        Перейти на сайт <i data-lucide="external-link" class="w-4 h-4"></i>
                    </a>
                    
                    <button onclick="shareProgram(${p.id}, '${p.title}')" class="w-14 h-14 flex items-center justify-center border border-slate-200 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition active:scale-95" data-tooltip="Поделиться">
                        <i data-lucide="share-2" class="w-6 h-6 text-slate-400"></i>
                    </button>
                    
                    <button onclick="toggleFav(${p.id}, this)" class="w-14 h-14 flex items-center justify-center border border-slate-200 dark:border-slate-600 rounded-xl hover:bg-slate-50 dark:hover:bg-slate-700 transition active:scale-95" data-tooltip="В избранное">
                        <i data-lucide="heart" class="w-6 h-6 ${favorites.includes(p.id) ? 'fill-red-500 text-red-500' : 'text-slate-400'}"></i>
                    </button>
                </div>
            `;
            const m = document.getElementById('modal');
            m.classList.remove('hidden');
            setTimeout(() => { m.querySelector('div').classList.remove('opacity-0'); document.getElementById('modalPanel').classList.remove('scale-95', 'opacity-0'); document.getElementById('modalPanel').classList.add('scale-100', 'opacity-100'); }, 10);
            lucide.createIcons();
        }

        function generateQR(url) {
            const container = document.getElementById('qrCodeContainer');
            if(!container.classList.contains('hidden')) {
                container.classList.add('hidden');
                return;
            }
            container.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}" alt="QR Code" class="rounded-xl border border-slate-200 p-2">`;
            container.classList.remove('hidden');
        }

        function shareProgram(id, title) {
            const url = `${window.location.origin}${window.location.pathname}#program=${id}`;
            if (navigator.share) {
                navigator.share({
                    title: title,
                    text: `Посмотри эту программу: ${title}`,
                    url: url
                }).catch(console.error);
            } else {
                navigator.clipboard.writeText(url).then(() => showToast('Ссылка скопирована'));
            }
        }

        function closeModal() {
            const m = document.getElementById('modal');
            document.getElementById('modalPanel').classList.remove('scale-100', 'opacity-100');
            document.getElementById('modalPanel').classList.add('scale-95', 'opacity-0');
            setTimeout(() => { 
                m.classList.add('hidden'); 
                // Don't reset hash if navigating back via history to avoid loops
            }, 200);
        }

        function openCompareModal() {
            const items = allPrograms.filter(p => compareList.has(p.id));
            if (items.length === 0) return;
            const keys = [
                { label: "Уровень", val: p => p.level === 'VO' ? 'ВУЗ' : 'Колледж' },
                { label: "Регион", val: p => p.region },
                { label: "Бюджет", val: p => p.places },
                { label: "Категория", val: p => p.cat }
            ];
            const renderRow = (k) => {
                const vals = items.map(p => k.val(p));
                const isDiff = new Set(vals).size > 1;
                return `<tr class="${isDiff ? 'diff-row' : ''}"><td class="p-4 border-b dark:border-slate-700 font-semibold text-slate-500 dark:text-slate-400 sticky left-0 bg-white dark:bg-slate-900 shadow-md z-10 text-sm">${k.label}</td>${items.map(p => `<td class="p-4 border-b dark:border-slate-700 min-w-[200px] text-sm text-slate-700 dark:text-slate-300">${k.val(p)}</td>`).join('')}</tr>`;
            };
            document.getElementById('compareContent').innerHTML = `<table class="w-full text-left border-collapse"><thead><tr><th class="p-4 border-b-2 dark:border-slate-600 min-w-[150px] bg-slate-50 dark:bg-slate-800 sticky left-0 z-20 shadow-md text-slate-400 font-bold uppercase text-xs">Параметр</th>${items.map(p => `<th class="p-4 border-b-2 dark:border-slate-600 min-w-[240px] bg-slate-50/80 dark:bg-slate-800/80 align-top"><div class="text-sm font-bold text-slate-900 dark:text-white leading-tight mb-1 line-clamp-2">${p.title}</div></th>`).join('')}</tr></thead><tbody>${keys.map(k => renderRow(k)).join('')}</tbody></table>`;
            document.getElementById('compareModal').classList.remove('hidden');
        }

        document.addEventListener('keydown', e => { if(e.key === "Escape") { closeModal(); document.getElementById('compareModal').classList.add('hidden'); blurSearch(); } });
    </script>
</body>
</html>
